<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
	<!-- PWA Meta Tags -->
	<link rel="manifest" href="manifest.json">
	<meta name="mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
	<meta name="apple-mobile-web-app-title" content="Site Engineer">
	<link rel="apple-touch-icon" href="assets/icon-192x192.png">
	<link rel="icon" type="image/png" href="assets/icon-192x192.png">
	<meta name="msapplication-TileColor" content="#2563eb">
	<meta name="msapplication-TileImage" content="assets/icon-144x144.png">
	<meta name="theme-color" content="#2563eb">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2563eb">
    <meta name="description" content="Comprehensive site engineering assistant for civil engineers and surveyors">
    <meta name="keywords" content="engineering, surveying, construction, field, TS16, GPS, DXF, AutoCAD, civil engineering">
    <title>Site Engineering Assistant v1.2</title>
    <style>
        /* ==============================================
           CSS PERFORMANCE OPTIMIZATIONS
           ============================================== */
        
        /* CSS Custom Properties for theme and safe areas */
        :root {
            --app-height: 100vh;
            --primary-color: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary-color: #475569;
            --background: #ffffff;
            --surface: #f8fafc;
            --border: #e2e8f0;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-tertiary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --radius: 12px;
            --radius-sm: 8px;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --safe-area-top: env(safe-area-inset-top, 0px);
            --safe-area-bottom: env(safe-area-inset-bottom, 0px);
            --safe-area-left: env(safe-area-inset-left, 0px);
            --safe-area-right: env(safe-area-inset-right, 0px);
        }
        
        [data-theme="dark"] {
            --primary-color: #3b82f6;
            --primary-dark: #2563eb;
            --secondary-color: #94a3b8;
            --background: #0f172a;
            --surface: #1e293b;
            --border: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-tertiary: #94a3b8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }
        
        /* CSS Reset with performance focus */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Fixed Layout Architecture - Critical for iOS performance */
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            position: fixed;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        #app-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            height: var(--app-height);
            display: flex;
            flex-direction: column;
            padding-top: var(--safe-area-top);
            padding-bottom: var(--safe-area-bottom);
            padding-left: var(--safe-area-left);
            padding-right: var(--safe-area-right);
            contain: layout paint style;
            will-change: transform;
        }
        
        /* Single Scrollable Content Area */
        #content-container {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            will-change: transform;
            background-color: var(--surface);
            border-top-left-radius: var(--radius);
            border-top-right-radius: var(--radius);
            position: relative;
            z-index: 1;
        }
        
        /* Touch-Optimized UI Elements */
        button, 
        .tab-button,
        .checklist-item,
        .accordion-header,
        .menu-item {
            min-height: 44px;
            min-width: 44px;
            padding: 12px 16px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            font-size: 16px;
        }
        
        input, textarea, select {
            font-size: 16px !important;
            min-height: 44px;
        }
        
        /* Smooth transitions with GPU acceleration */
        .accordion-content,
        .module-transition {
            transform: translateZ(0);
            backface-visibility: hidden;
            perspective: 1000px;
        }
        
        /* Header Styles */
        .app-header {
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            background-color: var(--background);
            border-bottom: 1px solid var(--border);
            z-index: 100;
            position: relative;
            contain: layout paint;
        }
        
        .header-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .header-actions {
            display: flex;
            gap: 12px;
        }
        
        .icon-button {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            transition: background-color 0.2s;
        }
        
        .icon-button:active {
            background-color: var(--surface);
        }
        
        /* Tab Navigation - Now 6 tabs */
        .tab-navigation {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            background-color: var(--background);
            border-top: 1px solid var(--border);
            height: 56px;
            min-height: 56px;
            position: relative;
            z-index: 100;
            contain: layout paint;
        }
        
        .tab-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            background: transparent;
            border: none;
            color: var(--text-tertiary);
            font-size: 11px;
            font-weight: 500;
            text-decoration: none;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
        
        .tab-button.active {
            color: var(--primary-color);
        }
        
        .tab-button.active::after {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 32px;
            height: 3px;
            background-color: var(--primary-color);
            border-radius: 0 0 2px 2px;
        }
        
        .tab-icon {
            font-size: 16px;
        }
        
        /* Module Content */
        .module-content {
            padding: 20px 16px 32px;
            animation: fadeIn 0.3s ease-out;
            contain: content;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .module-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text-primary);
            word-wrap: break-word;
            line-height: 1.3;
        }
        
        .module-subtitle {
            font-size: 14px;
            color: var(--text-tertiary);
            margin-bottom: 24px;
            line-height: 1.5;
            word-wrap: break-word;
        }
        
        /* Section Headers */
        .section-header {
            font-size: 18px;
            font-weight: 600;
            margin: 24px 0 16px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--primary-color);
            color: var(--text-primary);
            word-wrap: break-word;
            line-height: 1.4;
        }
        
        /* Accordion Styles - OPTIMIZED */
        .accordion {
            margin-bottom: 12px;
            background-color: var(--background);
            border-radius: var(--radius);
            overflow: hidden;
            border: 1px solid var(--border);
            contain: layout;
        }
        
        .accordion-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background-color: var(--background);
            border: none;
            width: 100%;
            text-align: left;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
        }
        
        .accordion-header:active {
            background-color: var(--surface);
        }
        
        .accordion-icon {
            transition: transform 0.3s ease;
            font-size: 20px;
            color: var(--text-tertiary);
            flex-shrink: 0;
        }
        
        .accordion-header.active .accordion-icon {
            transform: rotate(180deg);
        }
        
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background-color: var(--surface);
        }
        
        .accordion-content-inner {
            padding: 16px;
            border-top: 1px solid var(--border);
            will-change: transform;
        }
        
        /* Enhanced Problem-Solving Grid - OPTIMIZED */
        .scenario-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
            margin-top: 16px;
            contain: layout style;
        }
        
        .scenario-card {
            background-color: var(--background);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            padding: 16px;
            transition: transform 0.2s, box-shadow 0.2s;
            contain: content;
        }
        
        .scenario-card:hover, .scenario-card:active {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .scenario-title {
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 12px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            word-wrap: break-word;
            line-height: 1.4;
        }
        
        .scenario-icon {
            font-size: 20px;
            flex-shrink: 0;
        }
        
        .solution-list {
            padding-left: 20px;
            margin: 12px 0;
        }
        
        .solution-step {
            margin-bottom: 8px;
            line-height: 1.5;
            position: relative;
            padding-left: 8px;
            word-wrap: break-word;
        }
        
        .solution-step::before {
            content: "‚Üí";
            position: absolute;
            left: -15px;
            color: var(--primary-color);
        }
        
        .priority-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 8px;
            white-space: nowrap;
        }
        
        .priority-high {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }
        
        .priority-medium {
            background-color: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }
        
        .priority-low {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }
        
        /* Educational Tips */
        .educational-tip {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.05) 0%, rgba(59, 130, 246, 0.05) 100%);
            border-left: 4px solid var(--primary-color);
            padding: 12px 16px;
            margin: 16px 0;
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
        }
        
        .tip-title {
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
            word-wrap: break-word;
            line-height: 1.3;
        }
        
        .tip-content {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
            word-wrap: break-word;
        }
        
        /* Quick Reference Cards */
        .reference-card {
            background-color: var(--background);
            border-radius: var(--radius-sm);
            padding: 12px;
            border: 1px solid var(--border);
            margin-bottom: 8px;
            contain: content;
        }
        
        .reference-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 6px;
            font-size: 14px;
            word-wrap: break-word;
            line-height: 1.3;
        }
        
        .reference-value {
            font-family: monospace;
            background-color: var(--surface);
            padding: 8px;
            border-radius: 4px;
            font-size: 13px;
            margin: 8px 0;
            word-break: break-all;
            line-height: 1.4;
        }
        
        /* ENHANCED Checklist Styles - Multi-row text support */
        .checklist-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 16px;
        }
        
        .checklist-item {
            display: flex;
            align-items: flex-start;
            background-color: var(--background);
            border-radius: var(--radius);
            padding: 16px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
            contain: content;
            width: 100%;
            overflow: hidden;
        }
        
        .checklist-item:hover, .checklist-item:active {
            background-color: var(--surface);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }
        
        .checklist-checkbox {
            width: 22px;
            height: 22px;
            border-radius: 6px;
            border: 2px solid var(--border);
            background-color: var(--background);
            flex-shrink: 0;
            margin-top: 2px;
            position: relative;
            transition: all 0.2s;
        }
        
        .checklist-item.checked .checklist-checkbox {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .checklist-item.checked .checklist-checkbox::after {
            content: '‚úì';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 13px;
            font-weight: bold;
        }
        
        .checklist-content {
            flex: 1;
            margin-left: 14px;
            min-width: 0;
            overflow: hidden;
        }
        
        .checklist-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            line-height: 1.4;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .checklist-details {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 8px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .checklist-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
            align-items: center;
        }
        
        .checklist-category {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 20px;
            background-color: rgba(59, 130, 246, 0.1);
            color: var(--primary-color);
            font-weight: 500;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .checklist-critical {
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 4px;
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        /* Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }
        
        .badge-success {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }
        
        .badge-warning {
            background-color: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }
        
        .badge-danger {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }
        
        .badge-info {
            background-color: rgba(37, 99, 235, 0.1);
            color: var(--primary-color);
        }
        
        /* Glossary Styles */
        .glossary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
            margin-top: 16px;
            contain: layout style;
        }
        
        .glossary-category {
            margin-bottom: 24px;
        }
        
        .category-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 12px;
            padding-bottom: 4px;
            border-bottom: 1px solid var(--border);
            word-wrap: break-word;
            line-height: 1.3;
        }
        
        .glossary-term-card {
            background-color: var(--background);
            border-radius: var(--radius-sm);
            padding: 12px;
            border: 1px solid var(--border);
            margin-bottom: 8px;
            transition: transform 0.2s, box-shadow 0.2s;
            contain: content;
        }
        
        .glossary-term-card:active {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .term-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
            font-size: 14px;
            word-wrap: break-word;
            line-height: 1.3;
        }
        
        .term-definition {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.4;
            margin-bottom: 6px;
            word-wrap: break-word;
        }
        
        .term-example {
            font-size: 12px;
            color: var(--text-tertiary);
            font-style: italic;
            padding-left: 8px;
            border-left: 2px solid var(--primary-color);
            word-wrap: break-word;
            line-height: 1.4;
        }
        
        /* GPS Specific Styles */
        .gps-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 6px;
        }
        
        .gps-good {
            background-color: var(--success);
            box-shadow: 0 0 8px var(--success);
        }
        
        .gps-fair {
            background-color: var(--warning);
            box-shadow: 0 0 8px var(--warning);
        }
        
        .gps-poor {
            background-color: var(--danger);
            box-shadow: 0 0 8px var(--danger);
        }
        
        /* Search Input */
        .search-container {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: var(--surface);
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
        }
        
        .search-input {
            width: 100%;
            padding: 12px 16px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            background-color: var(--background);
            color: var(--text-primary);
            font-size: 16px;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: var(--text-tertiary);
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        /* Progress Indicators */
        .progress-container {
            background-color: var(--background);
            padding: 16px;
            border-radius: var(--radius);
            margin-bottom: 24px;
            border: 1px solid var(--border);
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .progress-bar {
            height: 8px;
            background-color: var(--border);
            border-radius: 4px;
            overflow: hidden;
            margin: 12px 0;
        }
        
        .progress-fill {
            height: 100%;
            background-color: var(--primary-color);
            transition: width 0.3s ease;
            border-radius: 4px;
        }
        
        .progress-stats {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: var(--text-tertiary);
            margin-top: 8px;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        /* Dark Mode Toggle */
        .theme-toggle {
            position: relative;
            width: 44px;
            height: 24px;
            background-color: var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .theme-toggle::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background-color: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }
        
        [data-theme="dark"] .theme-toggle {
            background-color: var(--primary-color);
        }
        
        [data-theme="dark"] .theme-toggle::after {
            transform: translateX(20px);
        }
        
        /* Loading States */
        .loading {
            opacity: 0.6;
            pointer-events: none;
            position: relative;
        }
        
        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 24px;
            height: 24px;
            border: 2px solid var(--border);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        /* Tooltip */
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }
        
        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 12px;
            background-color: var(--text-primary);
            color: var(--background);
            border-radius: var(--radius-sm);
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            pointer-events: none;
        }
        
        /* Note Box */
        .note-box {
            background-color: rgba(59, 130, 246, 0.1);
            border-left: 4px solid var(--primary-color);
            padding: 12px 16px;
            margin: 16px 0;
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
        }
        
        .note-title {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 4px;
            word-wrap: break-word;
            line-height: 1.3;
        }
        
        .note-content {
            font-size: 14px;
            color: var(--text-secondary);
            word-wrap: break-word;
            line-height: 1.5;
        }
        
        /* Command Box for AutoCAD Commands */
        .command-box {
            background-color: var(--surface);
            border-radius: var(--radius-sm);
            padding: 12px;
            margin: 12px 0;
            border-left: 3px solid var(--warning);
            font-family: 'Courier New', monospace;
            font-size: 14px;
            word-break: break-all;
            line-height: 1.4;
        }
        
        .command-title {
            font-weight: 600;
            color: var(--warning);
            margin-bottom: 4px;
            font-size: 13px;
        }
        
        /* Quality Checklist Styles */
        .qa-checklist {
            background-color: var(--background);
            border-radius: var(--radius);
            padding: 16px;
            margin: 16px 0;
            border: 2px solid var(--success);
        }
        
        .qa-title {
            font-weight: 700;
            color: var(--success);
            margin-bottom: 12px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .qa-phase {
            font-weight: 600;
            color: var(--primary-color);
            margin: 16px 0 8px 0;
            padding-bottom: 4px;
            border-bottom: 1px solid var(--border);
        }
        
        /* Calculator Styles */
        .calculator-container {
            background-color: var(--background);
            border-radius: var(--radius);
            padding: 20px;
            margin: 20px 0;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
        }
        
        .calculator-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .input-group {
            margin-bottom: 16px;
        }
        
        .input-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-secondary);
        }
        
        .input-field {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            background-color: var(--surface);
            color: var(--text-primary);
            font-size: 16px;
        }
        
        .input-field:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .calculator-result {
            margin-top: 20px;
            padding: 16px;
            background-color: rgba(16, 185, 129, 0.1);
            border-radius: var(--radius-sm);
            border-left: 4px solid var(--success);
        }
        
        .result-title {
            font-weight: 600;
            color: var(--success);
            margin-bottom: 8px;
        }
        
        .result-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            font-family: monospace;
        }
        
        .result-unit {
            font-size: 14px;
            color: var(--text-tertiary);
            margin-left: 4px;
        }
        
        .calculate-button {
            width: 100%;
            padding: 14px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .calculate-button:hover, .calculate-button:active {
            background-color: var(--primary-dark);
        }
        
        .formula-display {
            font-family: monospace;
            background-color: var(--surface);
            padding: 12px;
            border-radius: var(--radius-sm);
            margin: 12px 0;
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        /* About & Help Styles */
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 16px;
            margin: 20px 0;
        }
        
        .feature-card {
            background-color: var(--background);
            border-radius: var(--radius);
            padding: 20px;
            border: 1px solid var(--border);
            text-align: center;
            transition: transform 0.2s;
        }
        
        .feature-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
        }
        
        .feature-icon {
            font-size: 32px;
            margin-bottom: 12px;
        }
        
        .feature-title {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 8px;
            font-size: 16px;
        }
        
        .feature-description {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
        }
        
        /* Step-by-step Guide */
        .step-guide {
            counter-reset: step-counter;
            margin: 20px 0;
        }
        
        .step-item {
            display: flex;
            margin-bottom: 16px;
            position: relative;
            padding-left: 50px;
        }
        
        .step-item::before {
            counter-increment: step-counter;
            content: counter(step-counter);
            position: absolute;
            left: 0;
            top: 0;
            width: 36px;
            height: 36px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }
        
        .step-content {
            flex: 1;
        }
        
        .step-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--text-primary);
        }
        
        .step-description {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
        }
        
        /* Responsive Design */
        @media (min-width: 768px) {
            .app-header {
                padding: 0 24px;
            }
            
            .module-content {
                padding: 24px 24px 40px;
                max-width: 800px;
                margin: 0 auto;
                width: 100%;
            }
            
            .tab-navigation {
                max-width: 800px;
                margin: 0 auto;
                width: 100%;
            }
            
            .glossary-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .scenario-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .feature-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .tab-button {
                font-size: 12px;
            }
            
            .tab-icon {
                font-size: 18px;
            }
            
            .checklist-title {
                -webkit-line-clamp: 3;
            }
            
            .checklist-details {
                -webkit-line-clamp: 4;
            }
        }
        
        @media (max-width: 380px) {
            .tab-button {
                font-size: 10px;
                padding: 8px 4px;
            }
            
            .tab-icon {
                font-size: 14px;
            }
            
            .tab-button.active::after {
                width: 28px;
            }
            
            .checklist-title {
                font-size: 14px;
            }
            
            .checklist-details {
                font-size: 13px;
            }
            
            .feature-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Print Styles */
        @media print {
            .tab-navigation,
            .app-header {
                display: none;
            }
            
            #app-container {
                position: static;
                height: auto;
            }
            
            #content-container {
                overflow: visible;
                height: auto;
            }
            
            .checklist-item {
                break-inside: avoid;
            }
        }
        
        /* Accessibility */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        /* Focus styles for keyboard navigation */
        :focus-visible {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <!-- Fixed Layout Container -->
    <div id="app-container">
        <!-- Fixed Header -->
        <header class="app-header">
            <div class="header-title">
                <span class="header-icon">üìê</span>
                <span>Site Engineering Assistant v1.2</span>
            </div>
            <div class="header-actions">
                <button class="icon-button" id="search-toggle" aria-label="Search">
                    üîç
                </button>
                <button class="icon-button" id="about-toggle" aria-label="About & Help">
                    ‚ÑπÔ∏è
                </button>
                <button class="icon-button" id="theme-toggle" aria-label="Toggle theme">
                    <div class="theme-toggle"></div>
                </button>
            </div>
        </header>

        <!-- Search Overlay -->
        <div id="search-overlay" class="search-container" style="display: none;">
            <input 
                type="text" 
                class="search-input" 
                id="search-input" 
                placeholder="Search across all modules..."
                autocomplete="off"
            >
        </div>

        <!-- Single Scrollable Content Area -->
        <main id="content-container" role="main">
            <!-- Content will be dynamically loaded here -->
            <div id="module-content" class="module-content">
                <!-- Initial loading content -->
                <div class="empty-state">
                    <div class="empty-state-icon">üì±</div>
                    <h3>Site Engineering Assistant v1.2</h3>
                    <p>Select a module below to get started</p>
                </div>
            </div>
        </main>

        <!-- Fixed Tab Navigation - 6 Tabs (Added About) -->
        <nav class="tab-navigation" role="tablist">
            <button class="tab-button active" data-module="ts16" role="tab" aria-selected="true">
                <span class="tab-icon">üìç</span>
                <span>TS16 Guide</span>
            </button>
            <button class="tab-button" data-module="gps" role="tab" aria-selected="false">
                <span class="tab-icon">üõ∞Ô∏è</span>
                <span>Leica GPS</span>
            </button>
            <button class="tab-button" data-module="dxf" role="tab" aria-selected="false">
                <span class="tab-icon">üìÅ</span>
                <span>DXF Support</span>
            </button>
            <button class="tab-button" data-module="engineer" role="tab" aria-selected="false">
                <span class="tab-icon">üë∑</span>
                <span>Site Support</span>
            </button>
            <button class="tab-button" data-module="calculators" role="tab" aria-selected="false">
                <span class="tab-icon">üßÆ</span>
                <span>Calculators</span>
            </button>
            <button class="tab-button" data-module="about" role="tab" aria-selected="false">
                <span class="tab-icon">‚ÑπÔ∏è</span>
                <span>About & Help</span>
            </button>
        </nav>
    </div>

    <script>
        // ==============================================
        // PERFORMANCE-OPTIMIZED JAVASCRIPT
        // ==============================================

        // Global state management with minimal footprint
        const AppState = {
            currentModule: 'ts16',
            activeTab: 'ts16',
            expandedItems: new Set(),
            checkedItems: new Set(),
            theme: localStorage.getItem('theme') || 'light',
            searchQuery: '',
            lastScrollPosition: 0,
            glossaryFilter: 'all',
            expandedScenarios: new Set(),
            calculatorData: JSON.parse(localStorage.getItem('calculatorData')) || {}
        };

        // DOM Cache for performance
        const DOM = {
            appContainer: document.getElementById('app-container'),
            contentContainer: document.getElementById('content-container'),
            moduleContent: document.getElementById('module-content'),
            searchOverlay: document.getElementById('search-overlay'),
            searchInput: document.getElementById('search-input'),
            searchToggle: document.getElementById('search-toggle'),
            themeToggle: document.getElementById('theme-toggle'),
            aboutToggle: document.getElementById('about-toggle'),
            tabButtons: document.querySelectorAll('.tab-button')
        };

        // ==============================================
        // CRITICAL iOS FIXES
        // ==============================================

        // Fix 100vh issue on iOS
        function setAppHeight() {
            const doc = document.documentElement;
            doc.style.setProperty('--app-height', `${window.innerHeight}px`);
            
            // Force a reflow to ensure proper rendering
            const tabNav = document.querySelector('.tab-navigation');
            const tabNavHeight = tabNav ? tabNav.offsetHeight : 56;
            DOM.contentContainer.style.height = `calc(var(--app-height) - 60px - ${tabNavHeight}px)`;
        }

        // Prevent pull-to-refresh and bounce
        function preventDefaultTouchScroll(e) {
            if (e.target.closest('#content-container')) {
                if (DOM.contentContainer.scrollTop === 0 && e.touches[0].pageY > e.touches[0].clientY) {
                    e.preventDefault();
                }
            }
        }

        // ==============================================
        // DYNAMIC CALCULATOR MODULE
        // ==============================================

        const CalculatorData = {
            title: "Engineering Calculators",
            subtitle: "Interactive calculators for field calculations",
            calculators: [
                {
                    id: "volume-calculator",
                    title: "Volume Calculator - Cut/Fill",
                    icon: "üìê",
                    description: "Calculate earthwork volumes for cut and fill operations",
                    inputs: [
                        { id: "length", label: "Length (m)", type: "number", step: "0.1", placeholder: "Enter length", defaultValue: "" },
                        { id: "width", label: "Width (m)", type: "number", step: "0.1", placeholder: "Enter width", defaultValue: "" },
                        { id: "depth", label: "Average Depth (m)", type: "number", step: "0.01", placeholder: "Enter depth", defaultValue: "" },
                        { id: "swellFactor", label: "Swell Factor (%)", type: "number", step: "0.1", placeholder: "10 for clay", defaultValue: "10" }
                    ],
                    calculate: (inputs) => {
                        const length = parseFloat(inputs.length) || 0;
                        const width = parseFloat(inputs.width) || 0;
                        const depth = parseFloat(inputs.depth) || 0;
                        const swellFactor = parseFloat(inputs.swellFactor) || 0;
                        
                        const volume = length * width * depth;
                        const bulkedVolume = volume * (1 + swellFactor/100);
                        
                        return {
                            rawVolume: volume,
                            bulkedVolume: bulkedVolume,
                            swellFactor: swellFactor
                        };
                    },
                    formula: "V = Length √ó Width √ó Depth",
                    unit: "m¬≥",
                    notes: "Swell factor: Clay 10-30%, Sand 5-15%, Rock 20-40%"
                },
                {
                    id: "concrete-calculator",
                    title: "Concrete Quantity Calculator",
                    icon: "üèóÔ∏è",
                    description: "Calculate concrete volume and material requirements",
                    inputs: [
                        { id: "length", label: "Length (m)", type: "number", step: "0.1", placeholder: "Enter length", defaultValue: "" },
                        { id: "width", label: "Width (m)", type: "number", step: "0.1", placeholder: "Enter width", defaultValue: "" },
                        { id: "depth", label: "Depth (m)", type: "number", step: "0.01", placeholder: "Enter depth", defaultValue: "" },
                        { id: "wasteFactor", label: "Waste Factor (%)", type: "number", step: "0.1", placeholder: "5 for typical", defaultValue: "5" }
                    ],
                    calculate: (inputs) => {
                        const length = parseFloat(inputs.length) || 0;
                        const width = parseFloat(inputs.width) || 0;
                        const depth = parseFloat(inputs.depth) || 0;
                        const wasteFactor = parseFloat(inputs.wasteFactor) || 0;
                        
                        const volume = length * width * depth;
                        const totalVolume = volume * (1 + wasteFactor/100);
                        
                        // Calculate cement, sand, aggregate for 1:2:3 mix
                        const cementDensity = 1440; // kg/m¬≥
                        const mixRatio = { cement: 1, sand: 2, aggregate: 3 };
                        const totalParts = mixRatio.cement + mixRatio.sand + mixRatio.aggregate;
                        
                        const cement = (totalVolume * mixRatio.cement * cementDensity) / totalParts;
                        const sand = totalVolume * mixRatio.sand;
                        const aggregate = totalVolume * mixRatio.aggregate;
                        
                        return {
                            volume: volume,
                            totalVolume: totalVolume,
                            wasteFactor: wasteFactor,
                            materials: {
                                cement: cement,
                                sand: sand,
                                aggregate: aggregate
                            }
                        };
                    },
                    formula: "Volume = Length √ó Width √ó Depth",
                    unit: "m¬≥",
                    notes: "Standard mix ratio 1:2:3 (cement:sand:aggregate)"
                },
                {
                    id: "slope-calculator",
                    title: "Slope Ratio to Percentage",
                    icon: "‚ÜóÔ∏è",
                    description: "Convert slope ratios to percentages and vice versa",
                    inputs: [
                        { 
                            id: "calculationType", 
                            label: "Calculation Type", 
                            type: "select", 
                            options: [
                                { value: "ratioToPercent", label: "Ratio ‚Üí Percentage" },
                                { value: "percentToRatio", label: "Percentage ‚Üí Ratio" }
                            ],
                            defaultValue: "ratioToPercent"
                        },
                        { id: "rise", label: "Rise", type: "number", step: "0.01", placeholder: "Enter rise", defaultValue: "", condition: "ratioToPercent" },
                        { id: "run", label: "Run", type: "number", step: "0.01", placeholder: "Enter run", defaultValue: "", condition: "ratioToPercent" },
                        { id: "percentage", label: "Percentage (%)", type: "number", step: "0.1", placeholder: "Enter percentage", defaultValue: "", condition: "percentToRatio" }
                    ],
                    calculate: (inputs) => {
                        const calculationType = inputs.calculationType;
                        
                        if (calculationType === "ratioToPercent") {
                            const rise = parseFloat(inputs.rise) || 0;
                            const run = parseFloat(inputs.run) || 1;
                            
                            if (run === 0) return { error: "Run cannot be zero" };
                            
                            const percentage = (rise / run) * 100;
                            const ratio = `${rise}:${run}`;
                            
                            return {
                                percentage: percentage,
                                ratio: ratio,
                                calculationType: calculationType,
                                rise: rise,
                                run: run
                            };
                        } else {
                            const percentage = parseFloat(inputs.percentage) || 0;
                            const ratio = `1:${100/percentage}`;
                            const simplifiedRatio = simplifyRatio(1, 100/percentage);
                            
                            return {
                                percentage: percentage,
                                ratio: ratio,
                                simplifiedRatio: `${simplifiedRatio.numerator}:${simplifiedRatio.denominator}`,
                                calculationType: calculationType
                            };
                        }
                    },
                    formula: "% = (Rise √∑ Run) √ó 100",
                    notes: "Maximum accessible gradient: 1:12 (8.33%)"
                },
                {
                    id: "manhole-steps",
                    title: "Manhole Steps Calculator",
                    icon: "ü™ú",
                    description: "Calculate number of steps required for manholes",
                    inputs: [
                        { id: "invertLevel", label: "Invert Level (m)", type: "number", step: "0.001", placeholder: "e.g., 98.500", defaultValue: "" },
                        { id: "coverLevel", label: "Cover Level (m)", type: "number", step: "0.001", placeholder: "e.g., 101.200", defaultValue: "" },
                        { id: "stepRise", label: "Step Rise (mm)", type: "number", step: "1", placeholder: "150-175 typical", defaultValue: "150" }
                    ],
                    calculate: (inputs) => {
                        const invertLevel = parseFloat(inputs.invertLevel) || 0;
                        const coverLevel = parseFloat(inputs.coverLevel) || 0;
                        const stepRise = parseFloat(inputs.stepRise) || 150;
                        
                        if (coverLevel <= invertLevel) return { error: "Cover level must be higher than invert level" };
                        
                        const height = coverLevel - invertLevel;
                        const heightMm = height * 1000;
                        const steps = Math.round(heightMm / stepRise);
                        const actualStepRise = heightMm / steps;
                        
                        return {
                            height: height,
                            heightMm: heightMm,
                            steps: steps,
                            stepRise: stepRise,
                            actualStepRise: actualStepRise
                        };
                    },
                    formula: "Steps = (Cover Level - Invert Level) √ó 1000 √∑ Step Rise",
                    notes: "Standard step rise is 150-175mm for safety"
                },
                {
                    id: "pavement-thickness",
                    title: "Pavement Thickness Calculator",
                    icon: "üõ£Ô∏è",
                    description: "Calculate total pavement thickness from layers",
                    inputs: [
                        { id: "wearingCourse", label: "Wearing Course (mm)", type: "number", step: "1", placeholder: "e.g., 40", defaultValue: "" },
                        { id: "binderCourse", label: "Binder Course (mm)", type: "number", step: "1", placeholder: "e.g., 60", defaultValue: "" },
                        { id: "baseCourse", label: "Base Course (mm)", type: "number", step: "1", placeholder: "e.g., 200", defaultValue: "" },
                        { id: "subbase", label: "Sub-base (mm)", type: "number", step: "1", placeholder: "e.g., 150", defaultValue: "" }
                    ],
                    calculate: (inputs) => {
                        const wearingCourse = parseFloat(inputs.wearingCourse) || 0;
                        const binderCourse = parseFloat(inputs.binderCourse) || 0;
                        const baseCourse = parseFloat(inputs.baseCourse) || 0;
                        const subbase = parseFloat(inputs.subbase) || 0;
                        
                        const totalThickness = wearingCourse + binderCourse + baseCourse + subbase;
                        const totalMeters = totalThickness / 1000;
                        
                        return {
                            wearingCourse: wearingCourse,
                            binderCourse: binderCourse,
                            baseCourse: baseCourse,
                            subbase: subbase,
                            totalThickness: totalThickness,
                            totalMeters: totalMeters
                        };
                    },
                    formula: "Total = Wearing + Binder + Base + Sub-base",
                    unit: "mm",
                    notes: "Typical road pavement: 40mm WC + 60mm BC + 200mm Base + 150mm Sub-base = 450mm total"
                },
                {
                    id: "area-volume",
                    title: "Area & Volume from Coordinates",
                    icon: "üìè",
                    description: "Calculate area and volume from coordinates",
                    inputs: [
                        { id: "coordinates", label: "Coordinates (x,y per line)", type: "textarea", placeholder: "10,20\n30,40\n50,20\n...", defaultValue: "", rows: 4 },
                        { id: "depth", label: "Depth (m)", type: "number", step: "0.1", placeholder: "Average depth", defaultValue: "1.0" }
                    ],
                    calculate: (inputs) => {
                        const coordText = inputs.coordinates || "";
                        const depth = parseFloat(inputs.depth) || 0;
                        
                        // Parse coordinates
                        const lines = coordText.split('\n').filter(line => line.trim());
                        const points = [];
                        
                        for (const line of lines) {
                            const coords = line.split(',').map(coord => parseFloat(coord.trim()));
                            if (coords.length >= 2 && !isNaN(coords[0]) && !isNaN(coords[1])) {
                                points.push({ x: coords[0], y: coords[1] });
                            }
                        }
                        
                        if (points.length < 3) {
                            return { error: "At least 3 points required to form a polygon" };
                        }
                        
                        // Calculate area using Shoelace formula
                        let area = 0;
                        for (let i = 0; i < points.length; i++) {
                            const j = (i + 1) % points.length;
                            area += points[i].x * points[j].y;
                            area -= points[j].x * points[i].y;
                        }
                        area = Math.abs(area) / 2;
                        
                        const volume = area * depth;
                        
                        return {
                            points: points.length,
                            area: area,
                            volume: volume,
                            depth: depth
                        };
                    },
                    formula: "Area = ¬Ω|Œ£(x·µ¢y·µ¢‚Çä‚ÇÅ - x·µ¢‚Çä‚ÇÅy·µ¢)|",
                    notes: "Enter coordinates in clockwise or counterclockwise order"
                }
            ]
        };

        // Helper function to simplify ratios
        function simplifyRatio(num1, num2) {
            const gcd = (a, b) => {
                if (b < 0.000001) return a;
                return gcd(b, a % b);
            };
            
            const divisor = gcd(num1, num2);
            return {
                numerator: Math.round(num1 / divisor * 100) / 100,
                denominator: Math.round(num2 / divisor * 100) / 100
            };
        }

        // ==============================================
        // ABOUT & HELP MODULE
        // ==============================================

        const AboutData = {
            title: "About & How to Use",
            subtitle: "Site Engineering Assistant v1.2 - User Guide",
            sections: [
                {
                    type: "features",
                    title: "Key Features",
                    items: [
                        {
                            icon: "üìç",
                            title: "TS16 Total Station Guide",
                            description: "Complete field operations guide for Leica TS16 with step-by-step procedures"
                        },
                        {
                            icon: "üõ∞Ô∏è",
                            title: "Leica GPS System Guide",
                            description: "Comprehensive GPS operations with RTK setup and troubleshooting"
                        },
                        {
                            icon: "üìÅ",
                            title: "DXF Drawing Support",
                            description: "Interactive checklist for preparing CAD drawings for field equipment"
                        },
                        {
                            icon: "üë∑",
                            title: "Site Engineering Support",
                            description: "Glossary, QA checklists, and problem-solving scenarios"
                        },
                        {
                            icon: "üßÆ",
                            title: "Interactive Calculators",
                            description: "Dynamic calculators for volume, concrete, slopes, and more"
                        },
                        {
                            icon: "üîç",
                            title: "Smart Search",
                            description: "Search across all modules with instant results"
                        }
                    ]
                },
                {
                    type: "guide",
                    title: "How to Use This App",
                    steps: [
                        {
                            title: "Select a Module",
                            description: "Tap any of the 6 tabs at the bottom to access different engineering tools and references."
                        },
                        {
                            title: "Use Interactive Features",
                            description: "Check items in checklists, expand scenarios, use calculators with live results."
                        },
                        {
                            title: "Search Across All Content",
                            description: "Tap the search icon in the top right to find specific terms or procedures."
                        },
                        {
                            title: "Toggle Dark Mode",
                            description: "Use the theme toggle for comfortable viewing in different lighting conditions."
                        },
                        {
                            title: "Save Your Progress",
                            description: "Checklists and calculator inputs are automatically saved for your next visit."
                        },
                        {
                            title: "Work Offline",
                            description: "Once loaded, the app works completely offline - perfect for remote sites."
                        }
                    ]
                },
                {
                    type: "tips",
                    title: "Pro Tips",
                    items: [
                        "üí° Use the DXF checklist before exporting drawings to ensure field equipment compatibility",
                        "üí° Bookmark frequently used calculations by saving your inputs",
                        "üí° Search for engineering terms you're unfamiliar with using the glossary",
                        "üí° Take screenshots of calculation results for your site records",
                        "üí° Use dark mode for night work to reduce eye strain",
                        "üí° All data is stored locally - no internet required after initial load"
                    ]
                },
                {
                    type: "version",
                    title: "Version Information",
                    content: [
                        "Version: 1.2 - Enhanced with Dynamic Calculators",
                        "Last Updated: February 2024",
                        "Designed For: Civil Engineers, Surveyors, Site Managers",
                        "Compatibility: All modern browsers, iOS Safari, Android Chrome",
                        "Data Storage: Local browser storage only (no cloud)",
                        "Offline Support: Full offline functionality"
                    ]
                }
            ]
        };

        // ==============================================
        // ENHANCED MODULE DATA - INCLUDES ORIGINAL + NEW
        // ==============================================

        const ModuleData = {
            ts16: {
                title: "Total Station TS16 Field Guide",
                subtitle: "Comprehensive field operations guide for Leica TS16",
                sections: [
                    {
                        id: "pre-operation-checks",
                        title: "Pre-Operation Checks",
                        content: [
                            "Battery Level: Ensure minimum 50% charge before starting",
                            "Instrument Calibration: Check last calibration date (should be within 1 month)",
                            "Prism Constant: Verify setting matches prism type (usually -34.4mm)",
                            "Atmospheric Correction: Input temperature and pressure if >25¬∞C or >1000m altitude",
                            "Instrument Setup: Level bubble must be centered within 30 seconds"
                        ],
                        note: "Daily setup errors are the most common source of measurement inaccuracies"
                    },
                    {
                        id: "point-stakeout",
                        title: "Point Stake-Out Procedure",
                        content: [
                            "1. Set up over known control point with backsight verification",
                            "2. Load design coordinates (check coordinate system matches)",
                            "3. Select point to stake - verify point number matches setting out sheet",
                            "4. Use tracking mode to approach point location",
                            "5. Switch to fine measurement within 5m of target",
                            "6. Guide operator with clear hand signals or radio communication",
                            "7. Mark point with survey nail or spray paint",
                            "8. Record as-built measurement (deviation from design)",
                            "9. Stake next point or move to checking procedure"
                        ],
                        badges: [
                            { text: "Critical Step", type: "danger", note: "Backsight verification is mandatory" },
                            { text: "Tolerance", type: "warning", note: "¬±10mm for general works" }
                        ]
                    },
                    {
                        id: "line-alignment-work",
                        title: "Line & Alignment Work",
                        content: [
                            "Alignment Definition: Minimum 2 known points required",
                            "Offset Setup: Program offset before starting alignment",
                            "Interval Setting: Standard 5m intervals, 2m for curves",
                            "Critical Points: Mark PI, PT, PC with distinct markers",
                            "Vertical Alignment: Use cross-section mode for grade stakes",
                            "Verification: Independent check shots every 50m",
                            "Documentation: Record all critical points in field notes"
                        ]
                    },
                    {
                        id: "dtm-topographic-survey",
                        title: "DTM & Topographic Survey",
                        content: [
                            "Feature Coding: Establish consistent coding system before survey",
                            "Breakline Collection: Minimum density - 3m along line, 1m at changes",
                            "Spot Levels: High/low points, changes in gradient",
                            "Grid Method: Use for large flat areas (10m grid typical)",
                            "Edge Definition: Pavement edges, top/bottom of slopes",
                            "Building Corners: Measure all corners plus intermediate points",
                            "Tree Locations: Crown edge and trunk position",
                            "Export Format: CSV for processing, DXF for CAD"
                        ],
                        note: "A good DTM requires proper breakline definition - don't rely on triangulation alone"
                    },
                    {
                        id: "quality-control",
                        title: "Quality Control & Tolerances",
                        content: [
                            "Daily Setup Check: ¬±3mm on known point (repeatable)",
                            "Traverse Closure: ¬±15mm over 500m, ¬±5‚àökm for levels",
                            "Angle Measurement: ¬±2\" for precise work, ¬±5\" for general",
                            "Coordinate Check: ¬±10mm on known control points",
                            "Independent Verification: 5% of points checked by different method",
                            "Instrument Checks: Plummet alignment, optical plummet, compensator",
                            "Field Notes: All measurements recorded with time, date, weather"
                        ],
                        badges: [
                            { text: "ISO 9001", type: "info", note: "Document all checks" },
                            { text: "Critical", type: "danger", note: "No shortcuts on verification" }
                        ]
                    },
                    {
                        id: "common-errors",
                        title: "Common Field Errors & Solutions",
                        content: [
                            "Error: Wrong prism constant ‚Üí Solution: Always verify in EDM settings",
                            "Error: Not accounting for temperature ‚Üí Solution: Input temp if >25¬∞C difference from calibration",
                            "Error: Instrument settlement ‚Üí Solution: Wait 2 minutes after setup, re-check level",
                            "Error: Measuring to wrong face ‚Üí Solution: Always use face I, or correct face II readings",
                            "Error: Coordinate system mismatch ‚Üí Solution: Verify project settings match design files",
                            "Error: Parallax in sighting ‚Üí Solution: Focus eyepiece first, then objective",
                            "Error: Not allowing for refraction ‚Üí Solution: Use atmospheric correction for long lines (>100m)"
                        ]
                    }
                ]
            },

            gps: {
                title: "Leica GPS System Guide",
                subtitle: "Complete field operations guide for Leica GPS receivers (GS18, GS16, GS14)",
                sections: [
                    {
                        id: "gps-preparation",
                        title: "GPS Setup & Preparation",
                        content: [
                            "Battery Preparation: Charge main battery + 1 spare (minimum 80%)",
                            "SIM Card Check: Ensure data SIM has sufficient credit/plan",
                            "NTRIP Service: Verify subscription is active for RTK corrections",
                            "Instrument Calibration: Perform antenna calibration monthly",
                            "Memory Check: Ensure sufficient storage for planned survey",
                            "Accessory Check: Pole bubble, tribrach, data cable, charger"
                        ],
                        note: "GPS requires clear sky view - plan surveys avoiding buildings/trees"
                    },
                    {
                        id: "rtk-setup",
                        title: "RTK Setup Procedure",
                        content: [
                            "1. Extend pole to correct height (2.0m typical)",
                            "2. Connect to cellular network (check signal strength >3 bars)",
                            "3. Connect to NTRIP service (verify mount point is active)",
                            "4. Wait for RTK fix (typically 30-60 seconds)",
                            "5. Verify solution type: RTK Fixed (not Float or DGPS)",
                            "6. Check PDOP < 3.0, satellites > 12",
                            "7. Measure to known control point for verification",
                            "8. Record setup parameters in field notes"
                        ],
                        badges: [
                            { text: "Critical", type: "danger", note: "Must achieve RTK Fixed solution" },
                            { text: "Accuracy", type: "info", note: "¬±15mm horizontal, ¬±25mm vertical typical" }
                        ]
                    },
                    {
                        id: "static-survey",
                        title: "Static Survey Procedure",
                        content: [
                            "Session Planning: Minimum 2 hours for baselines <10km",
                            "Logging Rate: 15 seconds for general, 5 seconds for precise",
                            "Antenna Height: Measure to ARP (Antenna Reference Point)",
                            "Data Collection: Minimum 4 common satellites with both receivers",
                            "Weather Log: Record temperature, pressure, humidity",
                            "Occupancy Time: Longer = better (overnight for control networks)",
                            "File Management: Raw data + RINEX files for processing"
                        ],
                        note: "Static GPS provides highest accuracy for control networks"
                    },
                    {
                        id: "accuracy-factors",
                        title: "Accuracy Factors & Error Sources",
                        content: [
                            "Satellite Geometry: PDOP < 3.0 ideal, >6.0 unacceptable",
                            "Ionospheric Delay: Affects longer baselines (>20km)",
                            "Multipath: Avoid near buildings, vehicles, water",
                            "Tropospheric Delay: Use tropospheric models in processing",
                            "Orbital Errors: Use precise orbits (IGS products)",
                            "Receiver Noise: Higher quality receivers = less noise",
                            "Antenna Phase Center: Calibrated antenna models reduce errors"
                        ]
                    },
                    {
                        id: "troubleshooting",
                        title: "GPS Troubleshooting Guide",
                        content: [
                            "No RTK Fix: Check cellular signal, NTRIP credentials, satellite count",
                            "Poor Accuracy: Verify PDOP, check for multipath, verify antenna height",
                            "No Data Connection: Restart receiver, check SIM, verify APN settings",
                            "Quick Loss of Fix: Battery issue, poor satellite geometry",
                            "Incorrect Coordinates: Wrong coordinate system, incorrect antenna height",
                            "Weak Signal: Move to open area, extend observation time",
                            "Processing Errors: Insufficient data, cycle slips, low satellite count"
                        ],
                        badges: [
                            { text: "Common Issue", type: "warning", note: "Multipath is #1 error source" },
                            { text: "Solution", type: "success", note: "Move to open area, use choke ring antenna" }
                        ]
                    },
                    {
                        id: "best-practices",
                        title: "GPS Best Practices",
                        content: [
                            "Always use tripod for control points (not pole)",
                            "Measure antenna height twice (front/back of tribrach)",
                            "Record meteorological data for precise work",
                            "Use local base station when available (not NTRIP)",
                            "Process with multiple software for verification",
                            "Maintain observation logs with time, operator, equipment",
                            "Regularly update firmware and calibration files"
                        ],
                        note: "Good GPS practice = good field notes + proper equipment setup"
                    }
                ]
            },

            dxf: {
                title: "DWG ‚Üí DXF Field Support",
                subtitle: "Comprehensive drawing preparation checklist for field equipment compatibility",
                checklist: [
                    {
                        id: "check-coordinate-system",
                        title: "Coordinate System Verification",
                        details: "Ensure drawing uses project coordinate system (e.g., EPSG:27700 for UK). Check for false origins or local site grids. Verify transformation parameters if using combined systems. Validate against known control points.",
                        fix: "AutoCAD: ADESETCRDSYS to set correct system. LIST command on known points to verify. MAPEXPORT for coordinate system selection. GEOLOCATION to validate coordinates.",
                        critical: true,
                        category: "coordinates"
                    },
                    {
                        id: "check-scale",
                        title: "Scale Verification (1:1)",
                        details: "Drawings must be at full scale (1:1) for correct coordinate extraction. Common errors: drawing in mm when meters needed, scaled blocks, non-uniform scaling. Verify with known dimensions on drawing.",
                        fix: "UNITS command ‚Üí Set insertion units. SCALE command with Reference option. -DWGUNITS for unit conversion. DIST command to verify known dimensions.",
                        critical: true,
                        category: "scale"
                    },
                    {
                        id: "check-layers",
                        title: "Layer Structure Review",
                        details: "Only required layers should be present. Purge unused layers to reduce file size. Field software may have layer count limitations. Organize layers logically for field use.",
                        fix: "LAYDEL to delete unwanted layers. PURGE command (Purge All). LAYMRG to merge similar layers. Consider freezing non-essential layers. Use standard layer naming conventions.",
                        critical: false,
                        category: "organization"
                    },
                    {
                        id: "check-entity-types",
                        title: "Entity Type Check",
                        details: "Ensure all entities are simple geometry (lines, polylines, points). Complex objects (3D solids, regions) may not export correctly. Text must be single-line or exploded. Hatch patterns should be removed.",
                        fix: "EXPLODE blocks and complex entities. CONVERTPOLY for 3D polylines. OVERKILL to remove duplicates. FLATTEN for 3D to 2D conversion. BURST for blocks with attributes.",
                        critical: true,
                        category: "geometry"
                    },
                    {
                        id: "check-text-annotations",
                        title: "Text & Annotation Review",
                        details: "Text must be exploded or use standard SHX fonts. TrueType fonts may not display in field software. MText should be converted to single-line text. Dimension text should be exploded.",
                        fix: "TXTEXP to explode text. STYLE command to set simple fonts (Romans.shx). Purge unused text styles. -TEXTFIX for text repair. DIMBREAK then EXPLODE for dimensions.",
                        critical: false,
                        category: "text"
                    },
                    {
                        id: "check-file-version",
                        title: "DXF Version Selection",
                        details: "Use DXF R12 or R14 for maximum field equipment compatibility. Avoid newer versions (2000+). Binary DXF is smaller but ASCII is more compatible. Test export on field equipment.",
                        fix: "SAVEAS ‚Üí AutoCAD R12/LT2 DXF. Check 'Select Objects' to export only required geometry. Consider Binary DXF for large files. Test with field controller software.",
                        critical: true,
                        category: "export"
                    },
                    {
                        id: "check-cleaning",
                        title: "Drawing Clean-up",
                        details: "Remove duplicate entities, zero-length lines, and isolated points that cause processing errors. Ensure all entities are on correct layers. Remove unused blocks and layers.",
                        fix: "OVERKILL command with tolerance 0.001. AUDIT to fix errors. REGEN after cleaning. -PURGE with Regapps option. WBLOCK to create clean drawing.",
                        critical: false,
                        category: "cleanup"
                    },
                    {
                        id: "check-test-export",
                        title: "Test Export & Verification",
                        details: "Export test file and open in field software. Check coordinates of known points match AutoCAD. Verify layer visibility and entity integrity. Test with actual field equipment.",
                        fix: "Export small test area. Compare coordinates in field controller vs AutoCAD. Test with actual field equipment if possible. Verify point numbers and descriptions.",
                        critical: true,
                        category: "verification"
                    },
                    {
                        id: "check-block-attributes",
                        title: "Block & Attribute Handling",
                        details: "Blocks with attributes may not export correctly. Attributes can become text at wrong locations or disappear completely. Dynamic blocks may not be supported.",
                        fix: "EXPLODE all blocks with attributes. BURST command preserves attribute values as text. ATTOUT/ATTIN for attribute extraction. Convert dynamic blocks to simple blocks.",
                        critical: false,
                        category: "blocks"
                    },
                    {
                        id: "check-hatch-patterns",
                        title: "Hatch Pattern Removal",
                        details: "Hatch patterns significantly increase file size and may cause display issues in field software. They're unnecessary for coordinate extraction. Remove all hatch patterns.",
                        fix: "HATCH command ‚Üí Select hatch ‚Üí Delete. QSELECT for hatch selection. Consider converting to simple boundaries if needed. Use WIPEOUT instead of hatch.",
                        critical: false,
                        category: "cleanup"
                    },
                    {
                        id: "check-external-references",
                        title: "External References (Xrefs)",
                        details: "Xrefs must be bound or inserted. External references won't export in DXF. Check for nested Xrefs. Ensure all referenced content is in main drawing.",
                        fix: "XREF command ‚Üí Bind (Insert option). ETRANSMIT for complete package. -XREF to detach unused references. BIND all Xrefs before export.",
                        critical: true,
                        category: "organization"
                    },
                    {
                        id: "check-polyline-types",
                        title: "Polyline Type Verification",
                        details: "3D polylines and lightweight polylines may cause issues. Ensure all polylines are 2D and of consistent type. Check for closed polylines where needed.",
                        fix: "CONVERTPOLY to standard polylines. PEDIT to join segments. FLATTEN for 3D to 2D conversion. Ensure closed polylines for boundaries.",
                        critical: false,
                        category: "geometry"
                    }
                ],
                categories: {
                    coordinates: "Coordinate Systems",
                    scale: "Scale & Units",
                    organization: "Organization",
                    geometry: "Geometry",
                    text: "Text & Annotations",
                    export: "Export Settings",
                    cleanup: "Clean-up",
                    verification: "Verification",
                    blocks: "Blocks & Attributes"
                }
            },

            engineer: {
                title: "Site Engineer Support",
                subtitle: "Comprehensive field reference for civil engineering operations",
                sections: [
                    {
                        type: "glossary",
                        title: "Comprehensive Site Terminology",
                        categories: [
                            {
                                name: "Surveying & Setting Out",
                                terms: [
                                    { 
                                        term: "Bench Mark (BM)", 
                                        definition: "Permanent point of known elevation used as reference for leveling",
                                        example: "OS BM 123.456m AOD located on bridge abutment"
                                    },
                                    { 
                                        term: "Temporary Bench Mark (TBM)", 
                                        definition: "Temporary point established for site works, referenced to permanent BM",
                                        example: "TBM set on concrete kerb at RL 102.345m"
                                    },
                                    { 
                                        term: "Invert Level (IL)", 
                                        definition: "The lowest internal point of a pipe, culvert, or channel",
                                        example: "225mm √ò drainage pipe at IL 98.765m"
                                    },
                                    { 
                                        term: "Crown Level", 
                                        definition: "The highest point of a pipe or arch structure",
                                        example: "Pipe crown at 100.123m, invert at 99.898m"
                                    },
                                    { 
                                        term: "Reduced Level (RL)", 
                                        definition: "Height above datum (usually Ordnance Datum)",
                                        example: "Finished floor level at RL 105.670m AOD"
                                    },
                                    { 
                                        term: "Chainage (m)", 
                                        definition: "Distance along a survey line or centreline from a starting point",
                                        example: "Manhole at chainage 125.50m"
                                    },
                                    { 
                                        term: "Offset", 
                                        definition: "Perpendicular distance from a survey line or centreline",
                                        example: "Tree at 5.2m left offset from centreline"
                                    },
                                    { 
                                        term: "As-Built Drawings", 
                                        definition: "Revised drawings showing constructed works, including all variations from original design",
                                        example: "As-built drawings submitted for project handover showing actual pipe locations"
                                    },
                                    { 
                                        term: "Setting Out", 
                                        definition: "Process of marking design positions on ground for construction",
                                        example: "Setting out building corners using total station"
                                    },
                                    { 
                                        term: "Datum", 
                                        definition: "Reference point or surface against which measurements are made",
                                        example: "Ordnance Datum Newlyn (ODN) used as national datum"
                                    },
                                    { 
                                        term: "Finish Floor Level (FFL)", 
                                        definition: "The level of the finished floor surface after all floor finishes are applied",
                                        example: "FFL at RL 105.670m AOD including 150mm screed and floor tiles"
                                    },
                                    { 
                                        term: "Structural Slab Level (SSL)", 
                                        definition: "The level of the top of structural concrete slab before any screeds or finishes",
                                        example: "SSL at RL 105.520m AOD, allowing 150mm for screed to achieve FFL"
                                    },
                                    { 
                                        term: "Top of Kerb (TOK)", 
                                        definition: "The finished level at the top of a kerb unit",
                                        example: "TOK at RL 104.500m for edge of carriageway"
                                    },
                                    { 
                                        term: "Natural Ground Level (NGL)", 
                                        definition: "Original ground level before any excavation or filling",
                                        example: "NGL recorded before bulk excavation commenced"
                                    },
                                    { 
                                        term: "Platform Level", 
                                        definition: "The final level of a prepared area for construction",
                                        example: "Platform level established at RL 103.450m for building foundation"
                                    },
                                    { 
                                        term: "Gradient / Fall", 
                                        definition: "The slope of a surface expressed as a ratio, percentage, or 1 in X",
                                        example: "1:40 fall (2.5%) for drainage pipe"
                                    },
                                    { 
                                        term: "Centerline", 
                                        definition: "The central alignment or axis of a road, railway, or other linear feature",
                                        example: "Centerline established at chainage 0+000 to 1+500"
                                    },
                                    { 
                                        term: "Station", 
                                        definition: "Reference point along a survey line, usually at regular intervals",
                                        example: "Station 12+34.56 represents 1,234.56m from the start"
                                    },
                                    { 
                                        term: "Grid North", 
                                        definition: "North direction on a map grid, may differ from true north",
                                        example: "Grid north used for Ordnance Survey mapping in UK"
                                    },
                                    { 
                                        term: "True North", 
                                        definition: "Direction towards the geographic North Pole",
                                        example: "True north determined by GPS or astronomical observation"
                                    }
                                ]
                            },
                            {
                                name: "Earthworks & Grading",
                                terms: [
                                    { 
                                        term: "Batter", 
                                        definition: "Slope of an embankment or cutting, expressed as ratio horizontal:vertical",
                                        example: "2:1 batter means 2m horizontal for every 1m vertical"
                                    },
                                    { 
                                        term: "Cut & Fill", 
                                        definition: "Cut is excavation, fill is embankment material",
                                        example: "Balance cut and fill to minimize material export"
                                    },
                                    { 
                                        term: "Formation Level", 
                                        definition: "Final level of subgrade before pavement layers",
                                        example: "Formation at RL 103.450m, 150mm sub-base above"
                                    },
                                    { 
                                        term: "Bulk Excavation", 
                                        definition: "Large-scale earthmoving to achieve design levels",
                                        example: "Bulk excavation to formation minus 300mm for capping"
                                    },
                                    { 
                                        term: "Benching", 
                                        definition: "Excavating in steps to maintain slope stability",
                                        example: "3m high benching at 1:1.5 batter in clay"
                                    },
                                    { 
                                        term: "Capping Layer", 
                                        definition: "Layer of selected material placed directly on subgrade",
                                        example: "300mm Type 1 capping layer to improve bearing capacity"
                                    },
                                    { 
                                        term: "Compaction", 
                                        definition: "Process of densifying soil or aggregate",
                                        example: "98% compaction to BS 1377 for sub-base"
                                    },
                                    { 
                                        term: "Proof Roll", 
                                        definition: "Test to check subgrade stability using heavy equipment",
                                        example: "Proof roll with 8-tonne roller to check for soft spots"
                                    },
                                    { 
                                        term: "Geo-grid", 
                                        definition: "Synthetic material used to reinforce soil",
                                        example: "Biaxial geo-grid installed at formation level"
                                    },
                                    { 
                                        term: "Geo-textile", 
                                        definition: "Permeable fabric used for separation, filtration, or drainage",
                                        example: "Non-woven geo-textile placed between subgrade and sub-base"
                                    },
                                    { 
                                        term: "CBR Test (California Bearing Ratio)", 
                                        definition: "Laboratory test to evaluate mechanical strength of subgrade soils and base materials",
                                        example: "CBR value of 5% for clay subgrade, requiring 300mm capping layer"
                                    },
                                    { 
                                        term: "Soil Compaction Test", 
                                        definition: "Field test to determine density and moisture content of compacted soil",
                                        example: "98% compaction achieved relative to maximum dry density (MDD)"
                                    },
                                    { 
                                        term: "Plate Loading Test", 
                                        definition: "In-situ test to determine bearing capacity and settlement characteristics",
                                        example: "Plate load test to 150kPa for foundation design verification"
                                    },
                                    { 
                                        term: "Proctor Test", 
                                        definition: "Laboratory test to determine optimum moisture content and maximum dry density",
                                        example: "Optimum moisture content 12%, MDD 2.1 t/m¬≥"
                                    },
                                    { 
                                        term: "Swelling / Shrinkage", 
                                        definition: "Volume change in clay soils due to moisture content variation",
                                        example: "High plasticity clay with 10% volume change potential"
                                    },
                                    { 
                                        term: "Bearing Capacity", 
                                        definition: "Maximum pressure soil can withstand without failure",
                                        example: "Allowable bearing capacity 100kPa for strip foundation"
                                    },
                                    { 
                                        term: "Subgrade", 
                                        definition: "Natural soil or prepared ground supporting pavement layers",
                                        example: "Subgrade prepared and compacted to 95% MDD"
                                    },
                                    { 
                                        term: "Bulk Density", 
                                        definition: "Mass of soil per unit volume including air spaces",
                                        example: "Bulk density 1.8 t/m¬≥ for clay fill"
                                    },
                                    { 
                                        term: "Settlement", 
                                        definition: "Downward movement of soil under load",
                                        example: "Allowable settlement 25mm for building foundation"
                                    },
                                    { 
                                        term: "Consolidation", 
                                        definition: "Gradual compression of soil under sustained load",
                                        example: "Primary consolidation completed after 6 months"
                                    }
                                ]
                            },
                            {
                                name: "Drainage & Utilities",
                                terms: [
                                    { 
                                        term: "Manhole (MH)", 
                                        definition: "Access chamber to underground drainage system",
                                        example: "MH1 at chainage 125m, IL 99.234m"
                                    },
                                    { 
                                        term: "Catchpit (CP)", 
                                        definition: "Small drainage inlet for surface water",
                                        example: "CP5 with grating at RL 104.567m"
                                    },
                                    { 
                                        term: "Haunching", 
                                        definition: "Concrete or granular support at sides of pipes",
                                        example: "150mm granular haunching to pipe springing level"
                                    },
                                    { 
                                        term: "Soakaway", 
                                        definition: "Underground structure for infiltration of surface water",
                                        example: "3m¬≥ soakaway with geotextile wrap"
                                    },
                                    { 
                                        term: "Service Duct", 
                                        definition: "Concrete or plastic conduit for utilities",
                                        example: "150mm √ò duct for future telecoms at 600mm depth"
                                    },
                                    { 
                                        term: "Gully", 
                                        definition: "Drainage inlet typically at edge of pavement",
                                        example: "Road gully with 450x450mm frame and cover"
                                    },
                                    { 
                                        term: "Down Point", 
                                        definition: "Specific drainage outlet point directing water away from structure",
                                        example: "Down point at building corner discharging to drainage channel"
                                    },
                                    { 
                                        term: "Floor Drain", 
                                        definition: "Drainage outlet installed in floor slabs",
                                        example: "Floor drain in basement with grate cover"
                                    },
                                    { 
                                        term: "P-Trap", 
                                        definition: "U-shaped pipe fitting that retains water to prevent sewer gases",
                                        example: "P-trap installed under floor drain to prevent odors"
                                    },
                                    { 
                                        term: "Sump", 
                                        definition: "Pit or reservoir where liquid collects, typically with pump",
                                        example: "Basement sump with automatic pump for groundwater"
                                    },
                                    { 
                                        term: "Rodding Eye", 
                                        definition: "Access point for drain cleaning and inspection",
                                        example: "Rodding eye installed at 45m intervals along drain run"
                                    },
                                    { 
                                        term: "Flow Direction", 
                                        definition: "Direction of water flow in drainage system",
                                        example: "Flow direction marked on pipes with arrows"
                                    },
                                    { 
                                        term: "Backdrop Connection", 
                                        definition: "Vertical connection between drains at different levels",
                                        example: "Backdrop connection between upper and lower sewer"
                                    },
                                    { 
                                        term: "Interceptor", 
                                        definition: "Device to trap sediment and pollutants before discharge",
                                        example: "Petrol interceptor for car park drainage"
                                    },
                                    { 
                                        term: "Inspection Chamber (IC)", 
                                        definition: "Shallow access point for drainage inspection",
                                        example: "IC at 22.5m along 225mm √ò drain"
                                    },
                                    { 
                                        term: "Headwall", 
                                        definition: "Structure at the end of a culvert or drain",
                                        example: "Concrete headwall with wing walls at culvert outlet"
                                    },
                                    { 
                                        term: "French Drain", 
                                        definition: "Trench filled with gravel containing a perforated pipe",
                                        example: "French drain installed to lower groundwater level"
                                    },
                                    { 
                                        term: "Silt Trap", 
                                        definition: "Chamber to capture sediment before water enters drainage system",
                                        example: "Silt trap with removable bucket for easy cleaning"
                                    },
                                    { 
                                        term: "Storm Drain", 
                                        definition: "Drainage system for rainwater and surface water",
                                        example: "600mm √ò storm drain connecting to river outfall"
                                    },
                                    { 
                                        term: "Foul Drain", 
                                        definition: "Drainage system for wastewater from buildings",
                                        example: "150mm √ò foul drain to main sewer connection"
                                    }
                                ]
                            },
                            {
                                name: "Structures & Concrete",
                                terms: [
                                    { 
                                        term: "Kicker", 
                                        definition: "Small upstand cast with slab to form wall starter",
                                        example: "150mm high √ó 150mm wide kicker cast with slab"
                                    },
                                    { 
                                        term: "Pour Strip", 
                                        definition: "Temporary gap left in concrete pour for shrinkage control",
                                        example: "1m wide pour strip filled after 28 days"
                                    },
                                    { 
                                        term: "Construction Joint", 
                                        definition: "Planned interface between concrete pours",
                                        example: "Induced construction joint with waterstop at 15m intervals"
                                    },
                                    { 
                                        term: "Cover", 
                                        definition: "Concrete cover to reinforcement bars",
                                        example: "40mm minimum cover to all reinforcement"
                                    },
                                    { 
                                        term: "Vibrator", 
                                        definition: "Tool for compacting concrete to remove air voids",
                                        example: "Immersion vibrator for 10-15 seconds per insertion"
                                    },
                                    { 
                                        term: "Pre-pour Checklist", 
                                        definition: "Items to verify before concrete placement",
                                        example: "Check formwork, reinforcement, embedded items, and cleanliness"
                                    },
                                    { 
                                        term: "Post-pour Checklist", 
                                        definition: "Items to complete after concrete placement",
                                        example: "Curing, protection, testing, and formwork striking"
                                    },
                                    { 
                                        term: "Slump Test", 
                                        definition: "Test for workability of fresh concrete",
                                        example: "75mm slump for structural concrete"
                                    },
                                    { 
                                        term: "Cube Test", 
                                        definition: "Compression test for concrete strength",
                                        example: "3 cubes cast for 7, 14, and 28-day strength tests"
                                    },
                                    { 
                                        term: "Curing", 
                                        definition: "Process of maintaining moisture in concrete after placement",
                                        example: "7 days water curing for structural concrete"
                                    },
                                    { 
                                        term: "Formwork", 
                                        definition: "Temporary mould into which concrete is poured",
                                        example: "Ply-faced formwork for wall construction"
                                    },
                                    { 
                                        term: "Rebar", 
                                        definition: "Reinforcing steel bars in concrete",
                                        example: "T16 bars at 200mm centres in both directions"
                                    },
                                    { 
                                        term: "Day Joint", 
                                        definition: "Construction joint formed at end of day's pour",
                                        example: "Vertical day joint with shear keys in retaining wall"
                                    },
                                    { 
                                        term: "Soffit", 
                                        definition: "The underside of a slab, beam, or arch",
                                        example: "Soffit level of ground beam at RL 103.450m"
                                    },
                                    { 
                                        term: "Shuttering", 
                                        definition: "Temporary structure to contain wet concrete until set",
                                        example: "Steel shuttering for rapid turnaround on repetitive pours"
                                    },
                                    { 
                                        term: "Waterstop", 
                                        definition: "Continuous strip embedded in concrete joints to prevent water passage",
                                        example: "PVC waterstop at 300mm below construction joint"
                                    },
                                    { 
                                        term: "Laitance", 
                                        definition: "Weak layer of cement and fines that rises to surface of concrete",
                                        example: "Remove laitance before next concrete pour"
                                    },
                                    { 
                                        term: "Void Formers", 
                                        definition: "Temporary materials to create voids in concrete",
                                        example: "Polystyrene void formers for waffle slab"
                                    },
                                    { 
                                        term: "Construction Tolerance", 
                                        definition: "Permissible deviation from specified dimension",
                                        example: "¬±15mm for structural elements, ¬±5mm for finishes"
                                    },
                                    { 
                                        term: "Honeycombing", 
                                        definition: "Surface voids in concrete due to poor compaction",
                                        example: "Honeycombing repaired with polymer modified mortar"
                                    },
                                    { 
                                        term: "Bleeding", 
                                        definition: "Water rising to surface of freshly placed concrete",
                                        example: "Excessive bleeding indicates poor mix design"
                                    }
                                ]
                            },
                            {
                                name: "Quality Assurance & Control",
                                terms: [
                                    { 
                                        term: "ITP (Inspection & Test Plan)", 
                                        definition: "Document detailing inspection requirements and hold points",
                                        example: "ITP for concrete works includes slump tests and cube tests"
                                    },
                                    { 
                                        term: "RAMS (Risk Assessment Method Statement)", 
                                        definition: "Document combining risk assessment with method statement",
                                        example: "RAMS prepared for excavation works near services"
                                    },
                                    { 
                                        term: "QA (Quality Assurance)", 
                                        definition: "Process-oriented approach to prevent defects",
                                        example: "QA system ensures all materials meet specification"
                                    },
                                    { 
                                        term: "QC (Quality Control)", 
                                        definition: "Product-oriented approach to identify defects",
                                        example: "QC checks verify finished product meets requirements"
                                    },
                                    { 
                                        term: "Hold Point", 
                                        definition: "Stage where work must stop for inspection",
                                        example: "Hold point before concrete pour for inspection"
                                    },
                                    { 
                                        term: "Witness Point", 
                                        definition: "Stage where inspector is invited to witness activity",
                                        example: "Witness point for concrete slump test"
                                    },
                                    { 
                                        term: "Non-Conformance Report (NCR)", 
                                        definition: "Document recording work not meeting requirements",
                                        example: "NCR raised for non-specification materials"
                                    },
                                    { 
                                        term: "RFI (Request for Information)", 
                                        definition: "Formal request for clarification on drawings or specifications",
                                        example: "RFI raised for missing drainage detail"
                                    },
                                    { 
                                        term: "Snagging List", 
                                        definition: "List of defects to be corrected before handover",
                                        example: "Snagging list issued for final inspection"
                                    },
                                    { 
                                        term: "Commissioning", 
                                        definition: "Process of testing systems before handover",
                                        example: "Commissioning of drainage system with water test"
                                    },
                                    { 
                                        term: "Material Certificate", 
                                        definition: "Document verifying material meets specification",
                                        example: "Certificate of conformity for reinforcement steel"
                                    },
                                    { 
                                        term: "Sample Panel", 
                                        definition: "Representative section of work approved as quality standard",
                                        example: "Brickwork sample panel approved before main works"
                                    },
                                    { 
                                        term: "Test Certificate", 
                                        definition: "Document providing results of material or product testing",
                                        example: "Concrete cube test certificate showing 35N/mm¬≤ at 28 days"
                                    },
                                    { 
                                        term: "Quality Audit", 
                                        definition: "Systematic examination to determine effectiveness of quality system",
                                        example: "Monthly quality audit by project manager"
                                    },
                                    { 
                                        term: "Calibration Certificate", 
                                        definition: "Document confirming measuring equipment accuracy",
                                        example: "Calibration certificate for total station valid for 12 months"
                                    },
                                    { 
                                        term: "Workmanship", 
                                        definition: "Quality of work performed by tradespeople",
                                        example: "High standard of workmanship required for exposed concrete"
                                    },
                                    { 
                                        term: "Defects Liability Period", 
                                        definition: "Period after completion during which contractor must rectify defects",
                                        example: "12-month defects liability period for building works"
                                    }
                                ]
                            },
                            {
                                name: "Pavement & Roads",
                                terms: [
                                    { 
                                        term: "Camber", 
                                        definition: "Cross-fall on road surface for drainage",
                                        example: "2.5% camber from centerline to edge"
                                    },
                                    { 
                                        term: "Superelevation", 
                                        definition: "Banking on curves to counteract centrifugal force",
                                        example: "4% superelevation on 50m radius curve"
                                    },
                                    { 
                                        term: "Base Course", 
                                        definition: "Main structural layer of pavement",
                                        example: "200mm DTp1 base course, 98% compaction"
                                    },
                                    { 
                                        term: "Wearing Course", 
                                        definition: "Surface layer of pavement",
                                        example: "40mm SMA wearing course, 3-5mm chippings"
                                    },
                                    { 
                                        term: "Kerb (Curb)", 
                                        definition: "Edge restraint for pavement",
                                        example: "150x305mm pre-cast concrete bullnose kerb"
                                    },
                                    { 
                                        term: "Sub-base", 
                                        definition: "Layer between subgrade and base course",
                                        example: "150mm Type 1 sub-base, 95% compaction"
                                    },
                                    { 
                                        term: "Binder Course", 
                                        definition: "Intermediate layer between base and wearing course",
                                        example: "60mm AC20 dense binder course"
                                    },
                                    { 
                                        term: "Aggregate", 
                                        definition: "Crushed stone or gravel used in construction",
                                        example: "20mm nominal size aggregate for concrete mix"
                                    },
                                    { 
                                        term: "Prime Coat", 
                                        definition: "Bituminous layer applied to prepared base",
                                        example: "Prime coat to seal granular base before asphalt"
                                    },
                                    { 
                                        term: "Tack Coat", 
                                        definition: "Light bituminous spray between asphalt layers",
                                        example: "Tack coat between binder and wearing course"
                                    },
                                    { 
                                        term: "Edge Restraint", 
                                        definition: "Structure to contain pavement layers at edges",
                                        example: "Concrete edging as edge restraint for flexible pavement"
                                    },
                                    { 
                                        term: "Running Surface", 
                                        definition: "The traffic-bearing surface of a road",
                                        example: "Running surface finished to ¬±5mm tolerance"
                                    },
                                    { 
                                        term: "Shoulder", 
                                        definition: "Stabilised area adjacent to carriageway",
                                        example: "1.5m wide gravel shoulder each side of road"
                                    },
                                    { 
                                        term: "Carriageway", 
                                        definition: "The part of a road used by vehicles",
                                        example: "7.3m wide carriageway with 2 lanes"
                                    },
                                    { 
                                        term: "Footway (Pavement)", 
                                        definition: "Path for pedestrians alongside carriageway",
                                        example: "2.0m wide footway with tactile paving"
                                    },
                                    { 
                                        term: "Cycle Track", 
                                        definition: "Designated path for cyclists",
                                        example: "3.0m wide segregated cycle track"
                                    },
                                    { 
                                        term: "Road Base", 
                                        definition: "Main load-distributing layer of flexible pavement",
                                        example: "250mm road base to SHW Clause 803"
                                    },
                                    { 
                                        term: "Surface Dressing", 
                                        definition: "Bituminous surface treatment for waterproofing and skid resistance",
                                        example: "Surface dressing with 6mm chippings"
                                    },
                                    { 
                                        term: "Crack Sealing", 
                                        definition: "Process of filling cracks in pavement to prevent water ingress",
                                        example: "Crack sealing with hot-applied rubberized sealant"
                                    }
                                ]
                            },
                            {
                                name: "Health & Safety",
                                terms: [
                                    { 
                                        term: "RAMS", 
                                        definition: "Risk Assessment Method Statement",
                                        example: "RAMS prepared for excavation works"
                                    },
                                    { 
                                        term: "PTW (Permit to Work)", 
                                        definition: "Formal authorization for high-risk activities",
                                        example: "PTW required for confined space entry"
                                    },
                                    { 
                                        term: "SSOW (Safe System of Work)", 
                                        definition: "Procedures to eliminate or reduce risks",
                                        example: "SSOW implemented for working at height"
                                    },
                                    { 
                                        term: "COSHH", 
                                        definition: "Control of Substances Hazardous to Health",
                                        example: "COSHH assessment for epoxy resin"
                                    },
                                    { 
                                        term: "CDM", 
                                        definition: "Construction Design and Management Regulations",
                                        example: "CDM 2015 compliance required for all projects"
                                    },
                                    { 
                                        term: "Toolbox Talk", 
                                        definition: "Short safety briefing to work crew",
                                        example: "Daily toolbox talk before work commencement"
                                    },
                                    { 
                                        term: "Near Miss", 
                                        definition: "Incident that had potential to cause harm but didn't",
                                        example: "Near miss reported when material fell from height"
                                    },
                                    { 
                                        term: "PPE", 
                                        definition: "Personal Protective Equipment",
                                        example: "Hard hat, safety boots, hi-vis vest required on site"
                                    },
                                    { 
                                        term: "Method Statement", 
                                        definition: "Document describing how work will be carried out safely",
                                        example: "Method statement for piling operations"
                                    },
                                    { 
                                        term: "Risk Assessment", 
                                        definition: "Systematic examination of work activities to identify hazards",
                                        example: "Risk assessment for mobile plant operations"
                                    },
                                    { 
                                        term: "Exclusion Zone", 
                                        definition: "Area where access is restricted due to specific hazards",
                                        example: "10m exclusion zone around crane operations"
                                    },
                                    { 
                                        term: "Emergency Procedure", 
                                        definition: "Pre-planned response to specific emergency situations",
                                        example: "Emergency procedure for scaffold collapse"
                                    },
                                    { 
                                        term: "Lifting Plan", 
                                        definition: "Documented procedure for lifting operations",
                                        example: "Lifting plan for 5-tonne precast concrete panels"
                                    },
                                    { 
                                        term: "Confined Space", 
                                        definition: "Enclosed area with limited access and ventilation",
                                        example: "Manhole classified as confined space, requiring special procedures"
                                    },
                                    { 
                                        term: "Scaffold Tag", 
                                        definition: "Color-coded tag indicating scaffold status",
                                        example: "Green tag: safe for use, Red tag: do not use"
                                    },
                                    { 
                                        term: "Fall Protection", 
                                        definition: "Equipment and systems to prevent falls from height",
                                        example: "Harness and lanyard for work above 2m"
                                    }
                                ]
                            }
                        ]
                    },
                    {
                        type: "qa",
                        title: "Quality Assurance Checklists",
                        items: [
                            {
                                title: "Concrete Pre-pour Checklist",
                                phase: "Pre-pour",
                                items: [
                                    "Formwork clean and properly oiled",
                                    "All reinforcement in position with correct cover",
                                    "Kickers clean and free from laitance",
                                    "Embedded items (sockets, bolts) correctly positioned",
                                    "Construction joints prepared with waterstop if required",
                                    "Cleanliness check - no debris in pour area",
                                    "Supporting falsework adequate and braced",
                                    "Concrete delivery time confirmed",
                                    "Testing equipment ready (slump cone, cubes)",
                                    "Weather check - no rain forecast for 4 hours"
                                ]
                            },
                            {
                                title: "Concrete Post-pour Checklist",
                                phase: "Post-pour",
                                items: [
                                    "Concrete properly compacted with vibrator",
                                    "Surface finished to correct levels and tolerances",
                                    "Curing commenced immediately (polythene/water)",
                                    "Cube samples taken and labelled",
                                    "Formwork checked for leaks or movement",
                                    "Ambient temperature recorded",
                                    "Pour record completed with time, volume, mix",
                                    "Protection barriers installed around fresh concrete",
                                    "Next day inspection scheduled",
                                    "Stripping time determined based on cube results"
                                ]
                            },
                            {
                                title: "Drainage Installation Checklist",
                                phase: "Installation",
                                items: [
                                    "Pipe bedding material Type 1 or as specified",
                                    "Pipe joints properly made and sealed",
                                    "Correct gradient verified with level",
                                    "Haunching and surround material compacted",
                                    "Manholes built to correct levels and dimensions",
                                    "Gullies set at correct levels with proper falls",
                                    "All rodding eyes accessible",
                                    "Testing completed (water/air test as required)",
                                    "As-built measurements recorded",
                                    "Protection installed before backfilling"
                                ]
                            },
                            {
                                title: "As-built Drawing Requirements",
                                phase: "Documentation",
                                items: [
                                    "All changes from design recorded",
                                    "Photographs with scale and north arrow",
                                    "GPS coordinates of key features",
                                    "Manhole schedules with invert levels",
                                    "Pipe runs with gradients and diameters",
                                    "Utility diversions and new installations",
                                    "Structural deviations and modifications",
                                    "Date, time, and inspector details",
                                    "Cross-references to site diaries and RFIs",
                                    "Digital and hard copies maintained"
                                ]
                            }
                        ]
                    },
                    {
                        type: "scenarios",
                        title: "Field Problem Solving - Enhanced",
                        items: [
                            {
                                id: "design-mismatch",
                                scenario: "Design doesn't match existing construction?",
                                icon: "‚ö†Ô∏è",
                                priority: "high",
                                steps: [
                                    "Immediate Action: Stop work in affected area and secure site",
                                    "Documentation: Photograph from multiple angles with scale and date/time",
                                    "Measurement: Take precise as-built measurements using multiple methods",
                                    "Notification: Inform Site Manager and Design Team immediately via formal channels",
                                    "Formal Process: Raise RFI (Request for Information) with photos and measurements",
                                    "Professional Responsibility: Document professional opinion on impact",
                                    "Instruction: Wait for written instruction before proceeding - verbal not acceptable",
                                    "Recording: Document all communications in site diary with witness signatures"
                                ],
                                educational: {
                                    title: "Professional Responsibility",
                                    content: "As a site engineer, you have a duty of care to identify and report discrepancies. Failing to report can lead to professional negligence claims. Always follow the 'See it, Record it, Report it' principle."
                                },
                                reference: "CIOB Code of Practice Section 3.2: Site Verification Procedures"
                            },
                            {
                                id: "revised-drawings",
                                scenario: "Received revised drawings during works?",
                                icon: "üìã",
                                priority: "high",
                                steps: [
                                    "Verification: Check revision number, date, and authorisation stamp",
                                    "Withdrawal: Physically retrieve old drawings from site and stamp 'SUPERSEDED'",
                                    "Impact Assessment: Conduct a change impact analysis with the team",
                                    "Briefing: Conduct formal toolbox talk on changes with attendance register",
                                    "Method Statement: Update RAMS (Risk Assessment Method Statement)",
                                    "Implementation: Update setting out and check first application",
                                    "Quality Check: Verify implementation matches revised design",
                                    "Filing: Maintain revision register with cross-references to RFIs"
                                ],
                                educational: {
                                    title: "Change Management",
                                    content: "Construction changes must follow a formal change control process. Uncontrolled changes are a primary cause of project delays and cost overruns. Always maintain a 'single source of truth' for drawings."
                                },
                                reference: "ISO 9001:2015 - Control of documented information"
                            },
                            {
                                id: "drawing-markup",
                                scenario: "Need to mark up drawings for site use?",
                                icon: "‚úèÔ∏è",
                                priority: "medium",
                                steps: [
                                    "Standardization: Use red pen exclusively for all markups",
                                    "Identification: Date, initial, time, and location on every markup",
                                    "Reference System: Cross-reference to field notebook pages and photos",
                                    "Standard Symbols: ‚úì = verified, ? = query, ‚óã = dimension check, ‚ñ≥ = safety concern",
                                    "Original Preservation: Keep one clean master copy of all drawings",
                                    "Distribution: Copy marked drawings to relevant parties with transmittal",
                                    "Digital Backup: Scan important markups for electronic records",
                                    "Update Cycle: Transfer permanent markups to master set weekly"
                                ],
                                educational: {
                                    title: "Document Control",
                                    content: "Marked-up drawings are legal documents that can be used in disputes. Consistent, clear markups provide an audit trail of site decisions and verifications."
                                },
                                reference: "BS 1192:2007 - Collaborative production of architectural, engineering and construction information"
                            },
                            {
                                id: "underground-obstruction",
                                scenario: "Discover unexpected underground obstruction?",
                                icon: "üöß",
                                priority: "high",
                                steps: [
                                    "Safety First: Stop excavation, make area safe with barriers",
                                    "Investigation: Use CAT & Genny (Cable Avoidance Tool & Signal Generator)",
                                    "Documentation: Photograph, measure, and log findings with GPS coordinates",
                                    "Notification: Inform utilities companies via emergency line (UK: 111)",
                                    "Design Consultation: Engage designer for engineered solution",
                                    "Method Statement: Prepare new RAMS with updated risk assessments",
                                    "Permitting: Obtain necessary permits for modified works",
                                    "Recording: Update as-built drawings with obstruction details"
                                ],
                                educational: {
                                    title: "Utility Safety",
                                    content: "Striking underground services can be fatal. In the UK, 12 people die each year from utility strikes. Always assume services are present until proven otherwise. Use the 'PROD' method: Plan, Review, Operate, Dig."
                                },
                                reference: "HSG47 - Avoiding danger from underground services"
                            }
                        ]
                    }
                ]
            },

            calculators: CalculatorData,

            about: AboutData
        };

        // ==============================================
        // PERFORMANCE OPTIMIZED FUNCTIONS
        // ==============================================

        // Debounced search function
        const debounce = (func, wait) => {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        };

        // Efficient DOM creation
        const createElement = (tag, attributes = {}, children = []) => {
            const element = document.createElement(tag);
            
            for (const [key, value] of Object.entries(attributes)) {
                if (key === 'className') {
                    element.className = value;
                } else if (key === 'textContent') {
                    element.textContent = value;
                } else if (key === 'innerHTML') {
                    element.innerHTML = value;
                } else if (key === 'onClick') {
                    element.addEventListener('click', value);
                } else if (key === 'style' && typeof value === 'object') {
                    Object.assign(element.style, value);
                } else if (key.startsWith('on')) {
                    const eventName = key.substring(2).toLowerCase();
                    element.addEventListener(eventName, value);
                } else if (value !== undefined && value !== null) {
                    element.setAttribute(key, value);
                }
            }
            
            if (Array.isArray(children)) {
                children.forEach(child => {
                    if (typeof child === 'string') {
                        element.appendChild(document.createTextNode(child));
                    } else if (child instanceof Node) {
                        element.appendChild(child);
                    }
                });
            }
            
            return element;
        };

        // Fast template rendering for scenarios
        const renderScenarioTemplate = (scenario, index) => {
            const scenarioId = `scenario-${index}`;
            const isExpanded = AppState.expandedScenarios.has(scenarioId);
            
            return `
                <div class="scenario-card" data-scenario-id="${scenarioId}">
                    <div class="scenario-title">
                        <span class="scenario-icon">${scenario.icon}</span>
                        ${scenario.scenario}
                    </div>
                    <div class="priority-badge priority-${scenario.priority}">
                        Priority: ${scenario.priority.toUpperCase()}
                    </div>
                    <div class="solution-list" style="display: ${isExpanded ? 'block' : 'none'}">
                        ${scenario.steps.map((step, i) => `
                            <div class="solution-step">${step}</div>
                        `).join('')}
                    </div>
                    ${scenario.educational ? `
                        <div class="educational-tip" style="display: ${isExpanded ? 'block' : 'none'}">
                            <div class="tip-title">üìö ${scenario.educational.title}</div>
                            <div class="tip-content">${scenario.educational.content}</div>
                        </div>
                    ` : ''}
                    ${scenario.reference ? `
                        <div class="reference-card" style="display: ${isExpanded ? 'block' : 'none'}">
                            <div class="reference-title">Reference Standard</div>
                            <div class="reference-value">${scenario.reference}</div>
                        </div>
                    ` : ''}
                    <button class="scenario-toggle" data-scenario-id="${scenarioId}" 
                            style="margin-top: 12px; padding: 8px 16px; background: var(--primary-color); 
                                   color: white; border: none; border-radius: var(--radius-sm); 
                                   cursor: pointer; width: 100%;">
                        ${isExpanded ? 'Show Less ‚ñ≤' : 'Show Solution ‚ñº'}
                    </button>
                </div>
            `;
        };

        // Optimized scenario toggle handler
        const toggleScenario = (scenarioId) => {
            const scenarioElement = DOM.moduleContent.querySelector(`[data-scenario-id="${scenarioId}"]`);
            if (!scenarioElement) return;
            
            const solutionList = scenarioElement.querySelector('.solution-list');
            const educationalTip = scenarioElement.querySelector('.educational-tip');
            const referenceCard = scenarioElement.querySelector('.reference-card');
            const toggleButton = scenarioElement.querySelector('.scenario-toggle');
            
            if (AppState.expandedScenarios.has(scenarioId)) {
                AppState.expandedScenarios.delete(scenarioId);
                solutionList.style.display = 'none';
                if (educationalTip) educationalTip.style.display = 'none';
                if (referenceCard) referenceCard.style.display = 'none';
                toggleButton.textContent = 'Show Solution ‚ñº';
            } else {
                AppState.expandedScenarios.add(scenarioId);
                solutionList.style.display = 'block';
                if (educationalTip) educationalTip.style.display = 'block';
                if (referenceCard) referenceCard.style.display = 'block';
                toggleButton.textContent = 'Show Less ‚ñ≤';
            }
            
            saveAppState();
        };

        // ==============================================
        // CALCULATOR FUNCTIONS
        // ==============================================

        function renderCalculatorModule() {
            const module = ModuleData.calculators;
            const fragment = document.createDocumentFragment();
            
            fragment.appendChild(createElement('h1', { className: 'module-title' }, [module.title]));
            fragment.appendChild(createElement('p', { className: 'module-subtitle' }, [module.subtitle]));
            
            const introNote = createElement('div', { className: 'note-box' }, [
                createElement('div', { className: 'note-title' }, ['Interactive Calculators']),
                createElement('div', { className: 'note-content' }, [
                    'Enter values in the input fields and tap Calculate to see results. ',
                    'All inputs are automatically saved for your next visit.'
                ])
            ]);
            fragment.appendChild(introNote);
            
            // Create calculator grid
            const calculatorGrid = createElement('div', {
                className: 'feature-grid',
                style: { marginTop: '24px' }
            });
            
            module.calculators.forEach((calc, index) => {
                const calculatorCard = createElement('div', {
                    className: 'feature-card',
                    onClick: () => {
                        loadModule('calculators');
                        setTimeout(() => {
                            const calculatorElement = document.getElementById(`calculator-${calc.id}`);
                            if (calculatorElement) {
                                calculatorElement.scrollIntoView({ behavior: 'smooth' });
                            }
                        }, 100);
                    }
                }, [
                    createElement('div', { className: 'feature-icon' }, [calc.icon]),
                    createElement('div', { className: 'feature-title' }, [calc.title]),
                    createElement('div', { className: 'feature-description' }, [calc.description])
                ]);
                
                calculatorGrid.appendChild(calculatorCard);
            });
            
            fragment.appendChild(calculatorGrid);
            
            // Render individual calculators
            module.calculators.forEach((calculator, index) => {
                fragment.appendChild(createElement('h2', {
                    id: `calculator-${calculator.id}`,
                    className: 'section-header',
                    style: { marginTop: index === 0 ? '32px' : '48px' }
                }, [calculator.title]));
                
                const calculatorContainer = createElement('div', { className: 'calculator-container' });
                
                // Calculator description
                calculatorContainer.appendChild(createElement('div', {
                    style: { 
                        marginBottom: '16px',
                        color: 'var(--text-secondary)',
                        lineHeight: '1.5'
                    }
                }, [calculator.description]));
                
                // Formula display
                calculatorContainer.appendChild(createElement('div', { className: 'formula-display' }, [
                    'Formula: ', calculator.formula
                ]));
                
                // Input fields
                const savedInputs = AppState.calculatorData[calculator.id] || {};
                
                calculator.inputs.forEach(input => {
                    // Check if input should be shown based on conditions
                    if (input.condition) {
                        // We'll handle conditional visibility in the render function
                    }
                    
                    const inputGroup = createElement('div', { className: 'input-group' });
                    
                    inputGroup.appendChild(createElement('label', {
                        className: 'input-label',
                        htmlFor: `${calculator.id}-${input.id}`
                    }, [input.label]));
                    
                    if (input.type === 'select') {
                        const select = createElement('select', {
                            id: `${calculator.id}-${input.id}`,
                            className: 'input-field',
                            value: savedInputs[input.id] || input.defaultValue || ''
                        });
                        
                        input.options.forEach(option => {
                            const optionElement = createElement('option', {
                                value: option.value
                            }, [option.label]);
                            select.appendChild(optionElement);
                        });
                        
                        select.value = savedInputs[input.id] || input.defaultValue || '';
                        select.addEventListener('change', (e) => {
                            saveCalculatorInput(calculator.id, input.id, e.target.value);
                            updateCalculatorVisibility(calculator.id);
                            calculate(calculator.id);
                        });
                        
                        inputGroup.appendChild(select);
                    } else if (input.type === 'textarea') {
                        const textarea = createElement('textarea', {
                            id: `${calculator.id}-${input.id}`,
                            className: 'input-field',
                            rows: input.rows || 3,
                            placeholder: input.placeholder || ''
                        }, [savedInputs[input.id] || '']);
                        
                        textarea.addEventListener('input', debounce((e) => {
                            saveCalculatorInput(calculator.id, input.id, e.target.value);
                            calculate(calculator.id);
                        }, 300));
                        
                        inputGroup.appendChild(textarea);
                    } else {
                        const inputField = createElement('input', {
                            id: `${calculator.id}-${input.id}`,
                            className: 'input-field',
                            type: input.type || 'number',
                            step: input.step || 'any',
                            placeholder: input.placeholder || '',
                            value: savedInputs[input.id] || input.defaultValue || ''
                        });
                        
                        inputField.addEventListener('input', debounce((e) => {
                            saveCalculatorInput(calculator.id, input.id, e.target.value);
                            calculate(calculator.id);
                        }, 300));
                        
                        inputGroup.appendChild(inputField);
                    }
                    
                    calculatorContainer.appendChild(inputGroup);
                });
                
                // Calculate button
                calculatorContainer.appendChild(createElement('button', {
                    className: 'calculate-button',
                    onClick: () => calculate(calculator.id)
                }, ['Calculate']));
                
                // Result container
                const resultContainer = createElement('div', {
                    id: `${calculator.id}-result`,
                    className: 'calculator-result',
                    style: { display: 'none' }
                });
                
                resultContainer.appendChild(createElement('div', { className: 'result-title' }, ['Result']));
                resultContainer.appendChild(createElement('div', { 
                    id: `${calculator.id}-result-value`,
                    className: 'result-value' 
                }, ['']));
                
                calculatorContainer.appendChild(resultContainer);
                
                // Notes
                if (calculator.notes) {
                    calculatorContainer.appendChild(createElement('div', {
                        style: {
                            marginTop: '16px',
                            fontSize: '14px',
                            color: 'var(--text-tertiary)',
                            fontStyle: 'italic',
                            lineHeight: '1.5'
                        }
                    }, [calculator.notes]));
                }
                
                fragment.appendChild(calculatorContainer);
            });
            
            // Auto-calculate on module load
            setTimeout(() => {
                module.calculators.forEach(calc => {
                    calculate(calc.id);
                });
            }, 100);
            
            return fragment;
        }

        function saveCalculatorInput(calculatorId, inputId, value) {
            if (!AppState.calculatorData[calculatorId]) {
                AppState.calculatorData[calculatorId] = {};
            }
            AppState.calculatorData[calculatorId][inputId] = value;
            localStorage.setItem('calculatorData', JSON.stringify(AppState.calculatorData));
        }

        function calculate(calculatorId) {
            const calculator = ModuleData.calculators.calculators.find(c => c.id === calculatorId);
            if (!calculator) return;
            
            // Get all input values
            const inputs = {};
            calculator.inputs.forEach(input => {
                const element = document.getElementById(`${calculatorId}-${input.id}`);
                if (element) {
                    inputs[input.id] = element.value;
                }
            });
            
            // Perform calculation
            const result = calculator.calculate(inputs);
            
            // Display result
            const resultContainer = document.getElementById(`${calculatorId}-result`);
            const resultValue = document.getElementById(`${calculatorId}-result-value`);
            
            if (result.error) {
                resultValue.innerHTML = `<span style="color: var(--danger)">Error: ${result.error}</span>`;
                resultContainer.style.display = 'block';
                return;
            }
            
            // Format result based on calculator type
            let resultHTML = '';
            
            switch(calculatorId) {
                case 'volume-calculator':
                    resultHTML = `
                        Raw Volume: <strong>${result.rawVolume.toFixed(2)} m¬≥</strong><br>
                        With ${result.swellFactor}% swell: <strong>${result.bulkedVolume.toFixed(2)} m¬≥</strong>
                    `;
                    break;
                    
                case 'concrete-calculator':
                    resultHTML = `
                        Volume: <strong>${result.volume.toFixed(2)} m¬≥</strong><br>
                        Total (with ${result.wasteFactor}% waste): <strong>${result.totalVolume.toFixed(2)} m¬≥</strong><br>
                        Materials for 1:2:3 mix:<br>
                        ‚Ä¢ Cement: <strong>${result.materials.cement.toFixed(0)} kg</strong><br>
                        ‚Ä¢ Sand: <strong>${result.materials.sand.toFixed(2)} m¬≥</strong><br>
                        ‚Ä¢ Aggregate: <strong>${result.materials.aggregate.toFixed(2)} m¬≥</strong>
                    `;
                    break;
                    
                case 'slope-calculator':
                    if (result.calculationType === 'ratioToPercent') {
                        resultHTML = `
                            Ratio ${result.ratio} = <strong>${result.percentage.toFixed(2)}%</strong><br>
                            Gradient: 1 in ${(result.run / result.rise).toFixed(2)}
                        `;
                    } else {
                        resultHTML = `
                            ${result.percentage}% = Ratio <strong>${result.simplifiedRatio}</strong>
                        `;
                    }
                    break;
                    
                case 'manhole-steps':
                    resultHTML = `
                        Height: <strong>${result.height.toFixed(3)} m (${result.heightMm.toFixed(0)} mm)</strong><br>
                        Steps required: <strong>${result.steps}</strong><br>
                        Actual step rise: <strong>${result.actualStepRise.toFixed(1)} mm</strong>
                    `;
                    break;
                    
                case 'pavement-thickness':
                    resultHTML = `
                        Total thickness: <strong>${result.totalThickness.toFixed(0)} mm (${result.totalMeters.toFixed(3)} m)</strong><br>
                        Layer breakdown:<br>
                        ‚Ä¢ Wearing Course: ${result.wearingCourse} mm<br>
                        ‚Ä¢ Binder Course: ${result.binderCourse} mm<br>
                        ‚Ä¢ Base Course: ${result.baseCourse} mm<br>
                        ‚Ä¢ Sub-base: ${result.subbase} mm
                    `;
                    break;
                    
                case 'area-volume':
                    resultHTML = `
                        Points processed: <strong>${result.points}</strong><br>
                        Area: <strong>${result.area.toFixed(2)} m¬≤</strong><br>
                        Volume (depth ${result.depth}m): <strong>${result.volume.toFixed(2)} m¬≥</strong>
                    `;
                    break;
                    
                default:
                    resultHTML = `Result: <strong>${JSON.stringify(result)}</strong>`;
            }
            
            resultValue.innerHTML = resultHTML;
            resultContainer.style.display = 'block';
        }

        function updateCalculatorVisibility(calculatorId) {
            const calculator = ModuleData.calculators.calculators.find(c => c.id === calculatorId);
            if (!calculator) return;
            
            calculator.inputs.forEach(input => {
                const element = document.getElementById(`${calculatorId}-${input.id}`);
                if (element && input.condition) {
                    const selectElement = document.getElementById(`${calculatorId}-calculationType`);
                    if (selectElement) {
                        const calculationType = selectElement.value;
                        element.parentElement.style.display = (input.condition === calculationType) ? 'block' : 'none';
                    }
                }
            });
        }

        // ==============================================
        // ABOUT MODULE RENDERER
        // ==============================================

        function renderAboutModule() {
            const module = ModuleData.about;
            const fragment = document.createDocumentFragment();
            
            fragment.appendChild(createElement('h1', { className: 'module-title' }, [module.title]));
            fragment.appendChild(createElement('p', { className: 'module-subtitle' }, [module.subtitle]));
            
            module.sections.forEach((section, sectionIndex) => {
                fragment.appendChild(createElement('h2', { 
                    className: 'section-header',
                    style: { marginTop: sectionIndex === 0 ? '24px' : '32px' }
                }, [section.title]));
                
                if (section.type === 'features') {
                    const featureGrid = createElement('div', { className: 'feature-grid' });
                    
                    section.items.forEach(item => {
                        const featureCard = createElement('div', { className: 'feature-card' }, [
                            createElement('div', { className: 'feature-icon' }, [item.icon]),
                            createElement('div', { className: 'feature-title' }, [item.title]),
                            createElement('div', { className: 'feature-description' }, [item.description])
                        ]);
                        
                        featureGrid.appendChild(featureCard);
                    });
                    
                    fragment.appendChild(featureGrid);
                    
                } else if (section.type === 'guide') {
                    const stepGuide = createElement('div', { className: 'step-guide' });
                    
                    section.steps.forEach(step => {
                        const stepItem = createElement('div', { className: 'step-item' }, [
                            createElement('div', { className: 'step-content' }, [
                                createElement('div', { className: 'step-title' }, [step.title]),
                                createElement('div', { className: 'step-description' }, [step.description])
                            ])
                        ]);
                        
                        stepGuide.appendChild(stepItem);
                    });
                    
                    fragment.appendChild(stepGuide);
                    
                } else if (section.type === 'tips') {
                    const tipsList = createElement('ul', {
                        style: {
                            paddingLeft: '20px',
                            marginTop: '16px'
                        }
                    });
                    
                    section.items.forEach(tip => {
                        const li = createElement('li', {
                            style: {
                                marginBottom: '12px',
                                lineHeight: '1.5',
                                paddingLeft: '4px'
                            }
                        }, [tip]);
                        tipsList.appendChild(li);
                    });
                    
                    fragment.appendChild(tipsList);
                    
                } else if (section.type === 'version') {
                    const versionBox = createElement('div', {
                        style: {
                            backgroundColor: 'var(--background)',
                            borderRadius: 'var(--radius)',
                            padding: '20px',
                            border: '1px solid var(--border)',
                            marginTop: '16px'
                        }
                    });
                    
                    section.content.forEach(item => {
                        const itemDiv = createElement('div', {
                            style: {
                                marginBottom: '8px',
                                paddingBottom: '8px',
                                borderBottom: '1px solid var(--border)',
                                lineHeight: '1.5'
                            }
                        }, [item]);
                        versionBox.appendChild(itemDiv);
                    });
                    
                    fragment.appendChild(versionBox);
                }
            });
            
            // Contact/Feedback section
            const feedbackSection = createElement('div', {
                style: {
                    backgroundColor: 'var(--background)',
                    borderRadius: 'var(--radius)',
                    padding: '24px',
                    marginTop: '32px',
                    border: '2px solid var(--primary-color)',
                    textAlign: 'center'
                }
            }, [
                createElement('h3', { 
                    style: { 
                        color: 'var(--primary-color)',
                        marginBottom: '16px',
                        lineHeight: '1.3'
                    }
                }, ['üí° Have Suggestions?']),
                createElement('p', { 
                    style: { 
                        marginBottom: '20px',
                        lineHeight: '1.5',
                        color: 'var(--text-secondary)'
                    }
                }, ['This app is continuously improved based on user feedback. Share your ideas for new features or improvements.']),
                createElement('button', {
                    style: {
                        backgroundColor: 'var(--primary-color)',
                        color: 'white',
                        border: 'none',
                        padding: '12px 24px',
                        borderRadius: 'var(--radius-sm)',
                        cursor: 'pointer',
                        fontSize: '16px',
                        fontWeight: '600'
                    },
                    onClick: () => {
                        alert('Feature suggestion sent! Thank you for your feedback.');
                    }
                }, ['Send Feedback'])
            ]);
            
            fragment.appendChild(feedbackSection);
            
            return fragment;
        }

        // ==============================================
        // OPTIMIZED MODULE RENDERERS (ORIGINAL)
        // ==============================================

        function renderTS16Module() {
            const module = ModuleData.ts16;
            const fragment = document.createDocumentFragment();
            
            fragment.appendChild(createElement('h1', { className: 'module-title' }, [module.title]));
            fragment.appendChild(createElement('p', { className: 'module-subtitle' }, [module.subtitle]));
            
            const introNote = createElement('div', { className: 'note-box' }, [
                createElement('div', { className: 'note-title' }, ['Field Operations Principle']),
                createElement('div', { className: 'note-content' }, [
                    'Always follow this sequence: 1) Setup & Check, 2) Measure, 3) Verify, 4) Record. ',
                    'Never skip verification steps - they prevent costly rework.'
                ])
            ]);
            fragment.appendChild(introNote);
            
            module.sections.forEach(section => {
                fragment.appendChild(createElement('h2', { 
                    className: 'section-header',
                    style: { marginTop: '32px' }
                }, [section.title]));
                
                if (section.note) {
                    const note = createElement('div', { className: 'note-box' }, [
                        createElement('div', { className: 'note-title' }, ['Note']),
                        createElement('div', { className: 'note-content' }, [section.note])
                    ]);
                    fragment.appendChild(note);
                }
                
                if (section.badges) {
                    const badgesContainer = createElement('div', { 
                        style: { display: 'flex', gap: '8px', flexWrap: 'wrap', margin: '12px 0' }
                    });
                    section.badges.forEach(badge => {
                        badgesContainer.appendChild(
                            createElement('span', { 
                                className: `badge badge-${badge.type}`,
                                title: badge.note
                            }, [badge.text])
                        );
                    });
                    fragment.appendChild(badgesContainer);
                }
                
                if (section.content) {
                    const list = createElement('ul', { 
                        style: { 
                            marginTop: '12px', 
                            paddingLeft: '20px',
                            listStyleType: 'disc'
                        }
                    });
                    
                    section.content.forEach(item => {
                        const li = createElement('li', { 
                            style: { 
                                marginBottom: '8px', 
                                lineHeight: '1.6',
                                paddingLeft: '4px'
                            }
                        });
                        
                        if (/^\d+\./.test(item)) {
                            const parts = item.split('. ');
                            li.appendChild(createElement('strong', {}, [parts[0] + '. ']));
                            li.appendChild(document.createTextNode(parts.slice(1).join('. ')));
                        } else {
                            li.textContent = item;
                        }
                        
                        list.appendChild(li);
                    });
                    
                    fragment.appendChild(list);
                }
            });
            
            return fragment;
        }

        function renderGPSModule() {
            const module = ModuleData.gps;
            const fragment = document.createDocumentFragment();
            
            fragment.appendChild(createElement('h1', { className: 'module-title' }, [module.title]));
            fragment.appendChild(createElement('p', { className: 'module-subtitle' }, [module.subtitle]));
            
            const introNote = createElement('div', { className: 'note-box' }, [
                createElement('div', { className: 'note-title' }, ['GPS Fundamentals']),
                createElement('div', { className: 'note-content' }, [
                    'GPS accuracy depends on: Satellite geometry (PDOP), Signal quality, Observation time. ',
                    'Always verify against known control points before starting survey.'
                ])
            ]);
            fragment.appendChild(introNote);
            
            // GPS Status Legend
            const statusLegend = createElement('div', {
                style: {
                    backgroundColor: 'var(--background)',
                    padding: '16px',
                    borderRadius: 'var(--radius)',
                    marginBottom: '24px',
                    border: '1px solid var(--border)',
                    display: 'flex',
                    flexWrap: 'wrap',
                    gap: '16px',
                    justifyContent: 'center'
                }
            }, [
                createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '8px' } }, [
                    createElement('span', { className: 'gps-status gps-good' }),
                    createElement('span', { style: { fontSize: '14px' } }, ['Good: PDOP < 3, Sats > 12'])
                ]),
                createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '8px' } }, [
                    createElement('span', { className: 'gps-status gps-fair' }),
                    createElement('span', { style: { fontSize: '14px' } }, ['Fair: PDOP 3-6, Sats 8-12'])
                ]),
                createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '8px' } }, [
                    createElement('span', { className: 'gps-status gps-poor' }),
                    createElement('span', { style: { fontSize: '14px' } }, ['Poor: PDOP > 6, Sats < 8'])
                ])
            ]);
            fragment.appendChild(statusLegend);
            
            module.sections.forEach(section => {
                fragment.appendChild(createElement('h2', { 
                    className: 'section-header',
                    style: { marginTop: '32px' }
                }, [section.title]));
                
                if (section.note) {
                    const note = createElement('div', { className: 'note-box' }, [
                        createElement('div', { className: 'note-title' }, ['Note']),
                        createElement('div', { className: 'note-content' }, [section.note])
                    ]);
                    fragment.appendChild(note);
                }
                
                if (section.badges) {
                    const badgesContainer = createElement('div', { 
                        style: { display: 'flex', gap: '8px', flexWrap: 'wrap', margin: '12px 0' }
                    });
                    section.badges.forEach(badge => {
                        badgesContainer.appendChild(
                            createElement('span', { 
                                className: `badge badge-${badge.type}`,
                                title: badge.note
                            }, [badge.text])
                        );
                    });
                    fragment.appendChild(badgesContainer);
                }
                
                if (section.content) {
                    const list = createElement('ul', { 
                        style: { 
                            marginTop: '12px', 
                            paddingLeft: '20px',
                            listStyleType: 'disc'
                        }
                    });
                    
                    section.content.forEach(item => {
                        const li = createElement('li', { 
                            style: { 
                                marginBottom: '8px', 
                                lineHeight: '1.6',
                                paddingLeft: '4px'
                            }
                        });
                        
                        if (/^\d+\./.test(item)) {
                            const parts = item.split('. ');
                            li.appendChild(createElement('strong', {}, [parts[0] + '. ']));
                            li.appendChild(document.createTextNode(parts.slice(1).join('. ')));
                        } else {
                            li.textContent = item;
                        }
                        
                        list.appendChild(li);
                    });
                    
                    fragment.appendChild(list);
                }
            });
            
            return fragment;
        }

        function renderDXFModule() {
            const module = ModuleData.dxf;
            const fragment = document.createDocumentFragment();
            
            fragment.appendChild(createElement('h1', { className: 'module-title' }, [module.title]));
            fragment.appendChild(createElement('p', { className: 'module-subtitle' }, [module.subtitle]));
            
            // Progress tracking
            const checkedCount = Array.from(AppState.checkedItems).filter(id => 
                id.startsWith('dxf-')
            ).length;
            const totalItems = module.checklist.length;
            
            // Progress section
            const progressContainer = createElement('div', { className: 'progress-container' });
            
            const progressHeader = createElement('div', { className: 'progress-header' }, [
                createElement('span', { style: { fontWeight: '600', fontSize: '16px', lineHeight: '1.3' } }, ['Drawing Preparation Progress']),
                createElement('span', { style: { fontWeight: '700', color: 'var(--primary-color)' } }, [
                    `${checkedCount}/${totalItems}`
                ])
            ]);
            
            const progressBar = createElement('div', { className: 'progress-bar' }, [
                createElement('div', { 
                    className: 'progress-fill',
                    style: { width: `${(checkedCount / totalItems) * 100}%` }
                })
            ]);
            
            const progressStats = createElement('div', { className: 'progress-stats' }, [
                createElement('span', { style: { lineHeight: '1.4' } }, ['Critical checks: ', 
                    createElement('strong', { style: { color: 'var(--danger)' } }, [
                        module.checklist.filter(item => item.critical).length
                    ])
                ]),
                createElement('span', { style: { lineHeight: '1.4' } }, [
                    checkedCount === totalItems ? '‚úÖ Ready for export' :
                    checkedCount >= totalItems * 0.8 ? 'üü° Almost complete' :
                    'üî¥ Needs attention'
                ])
            ]);
            
            progressContainer.appendChild(progressHeader);
            progressContainer.appendChild(progressBar);
            progressContainer.appendChild(progressStats);
            fragment.appendChild(progressContainer);
            
            // Category filters
            const categoryFilters = createElement('div', {
                style: {
                    display: 'flex',
                    flexWrap: 'wrap',
                    gap: '8px',
                    padding: '12px 0 16px 0',
                    marginBottom: '16px'
                }
            });
            
            // Add "All" filter
            const allButton = createElement('button', {
                className: `badge ${AppState.glossaryFilter === 'all' ? 'badge-info' : ''}`,
                onClick: () => {
                    AppState.glossaryFilter = 'all';
                    loadModule('dxf');
                },
                style: {
                    cursor: 'pointer',
                    border: 'none',
                    padding: '6px 12px',
                    flexShrink: 0
                }
            }, ['All Checks']);
            categoryFilters.appendChild(allButton);
            
            // Add category filters
            Object.entries(module.categories).forEach(([id, name]) => {
                const button = createElement('button', {
                    className: `badge ${AppState.glossaryFilter === id ? 'badge-info' : ''}`,
                    onClick: () => {
                        AppState.glossaryFilter = id;
                        loadModule('dxf');
                    },
                    style: {
                        cursor: 'pointer',
                        border: 'none',
                        padding: '6px 12px',
                        flexShrink: 0
                    }
                }, [name]);
                categoryFilters.appendChild(button);
            });
            
            fragment.appendChild(categoryFilters);
            
            // ENHANCED Checklist container with multi-row text support
            const checklistContainer = createElement('div', { className: 'checklist-container' });
            
            // Checklist items
            module.checklist.forEach((item) => {
                // Apply filter
                if (AppState.glossaryFilter !== 'all' && item.category !== AppState.glossaryFilter) {
                    return;
                }
                
                const itemId = `dxf-${item.id}`;
                const isChecked = AppState.checkedItems.has(itemId);
                
                const checklistItem = createElement('div', { 
                    className: `checklist-item ${isChecked ? 'checked' : ''}`,
                    onClick: () => toggleChecklistItem(itemId)
                });
                
                const checkbox = createElement('div', { className: 'checklist-checkbox' });
                
                const content = createElement('div', { className: 'checklist-content' }, [
                    createElement('div', { className: 'checklist-title' }, [item.title]),
                    createElement('div', { className: 'checklist-details' }, [item.details]),
                    createElement('div', { className: 'checklist-meta' }, [
                        createElement('span', { className: 'checklist-category' }, [module.categories[item.category]]),
                        item.critical && createElement('span', { className: 'checklist-critical' }, ['Critical'])
                    ])
                ]);
                
                // Add AutoCAD command button
                const commandButton = createElement('button', {
                    style: {
                        backgroundColor: 'transparent',
                        border: '1px solid var(--border)',
                        borderRadius: 'var(--radius-sm)',
                        padding: '8px 12px',
                        fontSize: '12px',
                        color: 'var(--text-secondary)',
                        cursor: 'pointer',
                        marginTop: '12px',
                        width: '100%',
                        textAlign: 'left',
                        lineHeight: '1.4'
                    },
                    onClick: (e) => {
                        e.stopPropagation();
                        const modal = createElement('div', {
                            style: {
                                position: 'fixed',
                                top: '0',
                                left: '0',
                                width: '100%',
                                height: '100%',
                                backgroundColor: 'rgba(0,0,0,0.5)',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                zIndex: '1000',
                                padding: '20px'
                            },
                            onClick: (e) => {
                                if (e.target === modal) {
                                    document.body.removeChild(modal);
                                }
                            }
                        }, [
                            createElement('div', {
                                style: {
                                    backgroundColor: 'var(--background)',
                                    padding: '24px',
                                    borderRadius: 'var(--radius)',
                                    maxWidth: '500px',
                                    width: '100%',
                                    maxHeight: '80vh',
                                    overflowY: 'auto'
                                }
                            }, [
                                createElement('h3', { 
                                    style: { 
                                        marginBottom: '16px', 
                                        color: 'var(--primary-color)',
                                        fontSize: '18px',
                                        lineHeight: '1.3'
                                    }
                                }, ['AutoCAD Fix: ', item.title]),
                                createElement('div', { className: 'command-box' }, [
                                    createElement('div', { className: 'command-title' }, ['AutoCAD Command']),
                                    createElement('div', { style: { fontFamily: 'monospace', marginTop: '8px', lineHeight: '1.4' } }, [item.fix])
                                ]),
                                createElement('div', { 
                                    style: { 
                                        marginTop: '16px',
                                        fontSize: '14px',
                                        color: 'var(--text-secondary)',
                                        lineHeight: '1.5'
                                    }
                                }, ['How to use: Copy and paste this command into the AutoCAD command line']),
                                createElement('button', {
                                    style: {
                                        backgroundColor: 'var(--primary-color)',
                                        color: 'white',
                                        border: 'none',
                                        padding: '12px 24px',
                                        borderRadius: 'var(--radius-sm)',
                                        cursor: 'pointer',
                                        width: '100%',
                                        marginTop: '20px',
                                        fontSize: '16px'
                                    },
                                    onClick: () => document.body.removeChild(modal)
                                }, ['Close'])
                            ])
                        ]);
                        document.body.appendChild(modal);
                    }
                }, ['üîß Show AutoCAD Command']);
                
                content.appendChild(commandButton);
                
                checklistItem.appendChild(checkbox);
                checklistItem.appendChild(content);
                checklistContainer.appendChild(checklistItem);
            });
            
            fragment.appendChild(checklistContainer);
            
            // Export instructions
            if (checkedCount === totalItems) {
                const exportNote = createElement('div', { className: 'educational-tip' }, [
                    createElement('div', { className: 'tip-title' }, ['üéâ Ready to Export']),
                    createElement('div', { className: 'tip-content' }, [
                        'All checks completed! To export:',
                        createElement('ul', { style: { marginTop: '8px', paddingLeft: '20px' } }, [
                            createElement('li', { style: { lineHeight: '1.5' } }, ['File ‚Üí Save As ‚Üí AutoCAD R12/LT2 DXF']),
                            createElement('li', { style: { lineHeight: '1.5' } }, ['Select "Select Objects" to choose only required geometry']),
                            createElement('li', { style: { lineHeight: '1.5' } }, ['Test export on field equipment before full survey'])
                        ])
                    ])
                ]);
                fragment.appendChild(exportNote);
            }
            
            return fragment;
        }

        function renderEngineerModule() {
            const module = ModuleData.engineer;
            const fragment = document.createDocumentFragment();
            
            fragment.appendChild(createElement('h1', { className: 'module-title' }, [module.title]));
            fragment.appendChild(createElement('p', { className: 'module-subtitle' }, [module.subtitle]));
            
            const introNote = createElement('div', { className: 'note-box' }, [
                createElement('div', { className: 'note-title' }, ['Professional Site Engineering']),
                createElement('div', { className: 'note-content' }, [
                    'Site engineering requires technical knowledge, practical problem-solving, and professional judgment. ',
                    'This module provides comprehensive guidance for common field scenarios with educational insights.'
                ])
            ]);
            fragment.appendChild(introNote);
            
            module.sections.forEach((section, sectionIndex) => {
                fragment.appendChild(createElement('h2', { 
                    className: 'section-header',
                    style: { marginTop: sectionIndex === 0 ? '24px' : '32px' }
                }, [section.title]));
                
                if (section.type === 'glossary') {
                    section.categories.forEach(category => {
                        fragment.appendChild(createElement('h3', { 
                            className: 'category-title',
                            style: { marginTop: '24px' }
                        }, [category.name]));
                        
                        const grid = createElement('div', { className: 'glossary-grid' });
                        
                        category.terms.forEach(term => {
                            const termCard = createElement('div', { 
                                className: 'glossary-term-card',
                                onClick: () => {
                                    const modal = createElement('div', {
                                        style: {
                                            position: 'fixed',
                                            top: '0',
                                            left: '0',
                                            width: '100%',
                                            height: '100%',
                                            backgroundColor: 'rgba(0,0,0,0.5)',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            zIndex: '1000',
                                            padding: '20px'
                                        },
                                        onClick: (e) => {
                                            if (e.target === modal) {
                                                document.body.removeChild(modal);
                                            }
                                        }
                                    }, [
                                        createElement('div', {
                                            style: {
                                                backgroundColor: 'var(--background)',
                                                padding: '24px',
                                                borderRadius: 'var(--radius)',
                                                maxWidth: '500px',
                                                width: '100%'
                                            }
                                        }, [
                                            createElement('h3', { 
                                                style: { 
                                                    color: 'var(--primary-color)',
                                                    marginBottom: '12px',
                                                    fontSize: '18px',
                                                    lineHeight: '1.3'
                                                }
                                            }, [term.term]),
                                            createElement('div', { 
                                                style: { 
                                                    marginBottom: '16px',
                                                    lineHeight: '1.6'
                                                }
                                            }, [term.definition]),
                                            term.example && createElement('div', { 
                                                className: 'term-example',
                                                style: { marginTop: '12px', lineHeight: '1.4' }
                                            }, ['Example: ', term.example]),
                                            createElement('button', {
                                                style: {
                                                    backgroundColor: 'var(--primary-color)',
                                                    color: 'white',
                                                    border: 'none',
                                                    padding: '12px 24px',
                                                    borderRadius: 'var(--radius-sm)',
                                                    cursor: 'pointer',
                                                    width: '100%',
                                                    marginTop: '16px',
                                                    fontSize: '16px'
                                                },
                                                onClick: () => document.body.removeChild(modal)
                                            }, ['Close'])
                                        ])
                                    ]);
                                    document.body.appendChild(modal);
                                }
                            }, [
                                createElement('div', { className: 'term-name' }, [term.term]),
                                createElement('div', { className: 'term-definition' }, [
                                    term.definition.substring(0, 100) + (term.definition.length > 100 ? '...' : '')
                                ]),
                                term.example && createElement('div', { 
                                    className: 'term-example',
                                    style: { fontSize: '11px', marginTop: '4px', lineHeight: '1.4' }
                                }, [term.example.substring(0, 80) + '...'])
                            ]);
                            
                            grid.appendChild(termCard);
                        });
                        
                        fragment.appendChild(grid);
                    });
                    
                } else if (section.type === 'qa') {
                    // Quality Assurance Checklists
                    section.items.forEach(item => {
                        const qaContainer = createElement('div', { className: 'qa-checklist' });
                        
                        qaContainer.appendChild(createElement('div', { className: 'qa-title' }, [
                            createElement('span', {}, ['üìã ']),
                            item.title
                        ]));
                        
                        qaContainer.appendChild(createElement('div', { className: 'qa-phase' }, [
                            'Phase: ', item.phase
                        ]));
                        
                        const checklist = createElement('ul', {
                            style: {
                                paddingLeft: '20px',
                                marginTop: '12px'
                            }
                        });
                        
                        item.items.forEach((checklistItem, index) => {
                            const li = createElement('li', {
                                style: {
                                    marginBottom: '8px',
                                    lineHeight: '1.5',
                                    paddingLeft: '4px'
                                }
                            }, [checklistItem]);
                            checklist.appendChild(li);
                        });
                        
                        qaContainer.appendChild(checklist);
                        fragment.appendChild(qaContainer);
                    });
                    
                } else if (section.type === 'scenarios') {
                    const scenariosContainer = createElement('div', { 
                        className: 'scenario-grid',
                        innerHTML: section.items.map((scenario, index) => 
                            renderScenarioTemplate(scenario, index)
                        ).join('')
                    });
                    
                    setTimeout(() => {
                        const toggleButtons = scenariosContainer.querySelectorAll('.scenario-toggle');
                        toggleButtons.forEach(button => {
                            button.addEventListener('click', (e) => {
                                e.stopPropagation();
                                const scenarioId = button.dataset.scenarioId;
                                toggleScenario(scenarioId);
                            });
                        });
                    }, 0);
                    
                    fragment.appendChild(scenariosContainer);
                }
            });
            
            const practiceNote = createElement('div', { className: 'educational-tip' }, [
                createElement('div', { className: 'tip-title' }, ['üèÜ Professional Best Practice']),
                createElement('div', { className: 'tip-content' }, [
                    createElement('div', { style: { lineHeight: '1.5' } }, ['1. Document everything: Photos, measurements, communications']),
                    createElement('div', { style: { lineHeight: '1.5' } }, ['2. Follow formal processes: RFIs, NCRs, change requests']),
                    createElement('div', { style: { lineHeight: '1.5' } }, ['3. Maintain professional independence: Your judgment matters']),
                    createElement('div', { style: { lineHeight: '1.5' } }, ['4. Continuous learning: Stay updated with standards and technology']),
                    createElement('div', { style: { lineHeight: '1.5' } }, ['5. Safety first: Never compromise on safety procedures'])
                ])
            ]);
            fragment.appendChild(practiceNote);
            
            return fragment;
        }

        // ==============================================
        // CORE APPLICATION FUNCTIONS
        // ==============================================

        function loadModule(moduleId) {
            if (!ModuleData[moduleId]) {
                console.error(`Module ${moduleId} not found`);
                return;
            }
            
            AppState.currentModule = moduleId;
            AppState.lastScrollPosition = DOM.contentContainer.scrollTop;
            
            DOM.tabButtons.forEach(btn => {
                const isActive = btn.dataset.module === moduleId;
                btn.classList.toggle('active', isActive);
                btn.setAttribute('aria-selected', isActive);
                btn.setAttribute('tabindex', isActive ? '0' : '-1');
            });
            
            DOM.moduleContent.innerHTML = '';
            DOM.moduleContent.classList.add('loading');
            
            requestAnimationFrame(() => {
                let content;
                switch(moduleId) {
                    case 'ts16':
                        content = renderTS16Module();
                        break;
                    case 'gps':
                        content = renderGPSModule();
                        break;
                    case 'dxf':
                        content = renderDXFModule();
                        break;
                    case 'engineer':
                        content = renderEngineerModule();
                        break;
                    case 'calculators':
                        content = renderCalculatorModule();
                        break;
                    case 'about':
                        content = renderAboutModule();
                        break;
                    default:
                        content = document.createDocumentFragment();
                }
                
                if (content) {
                    DOM.moduleContent.appendChild(content);
                }
                
                DOM.moduleContent.classList.remove('loading');
                
                setTimeout(() => {
                    DOM.contentContainer.scrollTop = 0;
                    AppState.activeTab = moduleId;
                }, 10);
                
                document.title = `${ModuleData[moduleId].title} - Site Engineering Assistant v1.2`;
                
                // Update calculator visibility for conditional inputs
                if (moduleId === 'calculators') {
                    ModuleData.calculators.calculators.forEach(calc => {
                        updateCalculatorVisibility(calc.id);
                    });
                }
            });
            
            saveAppState();
        }

        function toggleChecklistItem(itemId) {
            if (AppState.checkedItems.has(itemId)) {
                AppState.checkedItems.delete(itemId);
            } else {
                AppState.checkedItems.add(itemId);
            }
            
            if (AppState.currentModule === 'dxf') {
                const itemElement = DOM.moduleContent.querySelector(`[onclick*="${itemId}"]`);
                if (itemElement) {
                    itemElement.classList.toggle('checked', AppState.checkedItems.has(itemId));
                    updateProgressBar();
                }
            }
            
            saveAppState();
        }

        function updateProgressBar() {
            if (AppState.currentModule !== 'dxf') return;
            
            const checkedCount = Array.from(AppState.checkedItems).filter(id => 
                id.startsWith('dxf-')
            ).length;
            const totalItems = ModuleData.dxf.checklist.length;
            
            const progressFill = DOM.moduleContent.querySelector('.progress-fill');
            if (progressFill) {
                progressFill.style.width = `${(checkedCount / totalItems) * 100}%`;
            }
            
            const progressText = DOM.moduleContent.querySelector('.progress-header span:last-child');
            if (progressText) {
                progressText.textContent = `${checkedCount}/${totalItems}`;
            }
            
            const progressStats = DOM.moduleContent.querySelector('.progress-stats span:last-child');
            if (progressStats) {
                progressStats.innerHTML = checkedCount === totalItems ? '‚úÖ Ready for export' :
                    checkedCount >= totalItems * 0.8 ? 'üü° Almost complete' :
                    'üî¥ Needs attention';
            }
        }

        function toggleTheme() {
            const newTheme = AppState.theme === 'light' ? 'dark' : 'light';
            AppState.theme = newTheme;
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }

        function toggleSearch() {
            const isVisible = DOM.searchOverlay.style.display !== 'none';
            DOM.searchOverlay.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible) {
                setTimeout(() => {
                    DOM.searchInput.focus();
                    DOM.searchInput.select();
                }, 100);
            } else {
                DOM.searchInput.blur();
            }
        }

        function showAbout() {
            loadModule('about');
        }

        function performSearch(query) {
            AppState.searchQuery = query.toLowerCase().trim();
            
            if (!AppState.searchQuery) {
                loadModule(AppState.currentModule);
                return;
            }
            
            const results = [];
            const searchTerms = AppState.searchQuery.split(' ').filter(term => term.length > 2);
            
            const containsAllTerms = (text) => {
                return searchTerms.every(term => text.toLowerCase().includes(term));
            };
            
            // Search in all modules
            Object.entries(ModuleData).forEach(([moduleId, module]) => {
                if (module.sections) {
                    module.sections.forEach(section => {
                        if (containsAllTerms(section.title) || 
                            (section.content && section.content.some(item => containsAllTerms(item)))) {
                            results.push({
                                module: moduleId,
                                title: section.title,
                                content: section.content ? 
                                    section.content.find(item => containsAllTerms(item)) || section.content[0] :
                                    'Section content',
                                type: module.title
                            });
                        }
                    });
                }
                
                if (module.checklist) {
                    module.checklist.forEach(item => {
                        if (containsAllTerms(item.title) || 
                            containsAllTerms(item.details)) {
                            results.push({
                                module: moduleId,
                                title: item.title,
                                content: item.details,
                                type: module.title
                            });
                        }
                    });
                }
                
                if (moduleId === 'engineer' && module.sections) {
                    module.sections.forEach(section => {
                        if (section.type === 'glossary') {
                            section.categories.forEach(category => {
                                category.terms.forEach(term => {
                                    if (containsAllTerms(term.term) || 
                                        containsAllTerms(term.definition)) {
                                        results.push({
                                            module: moduleId,
                                            title: term.term,
                                            content: term.definition,
                                            type: module.title + ' - Glossary'
                                        });
                                    }
                                });
                            });
                        } else if (section.type === 'qa') {
                            section.items.forEach(item => {
                                if (containsAllTerms(item.title)) {
                                    results.push({
                                        module: moduleId,
                                        title: item.title,
                                        content: `Checklist for ${item.phase} phase`,
                                        type: module.title + ' - QA Checklists'
                                    });
                                }
                            });
                        }
                    });
                }
                
                if (moduleId === 'calculators' && module.calculators) {
                    module.calculators.forEach(calc => {
                        if (containsAllTerms(calc.title) || 
                            containsAllTerms(calc.description)) {
                            results.push({
                                module: moduleId,
                                title: calc.title,
                                content: calc.description,
                                type: module.title
                            });
                        }
                    });
                }
            });
            
            displaySearchResults(results);
        }

        function displaySearchResults(results) {
            DOM.moduleContent.innerHTML = '';
            
            if (results.length === 0) {
                DOM.moduleContent.appendChild(createElement('div', { className: 'empty-state' }, [
                    createElement('div', { className: 'empty-state-icon' }, ['üîç']),
                    createElement('h3', {}, ['No results found']),
                    createElement('p', {}, [
                        'No matches for "', 
                        createElement('strong', {}, [AppState.searchQuery]),
                        '"'
                    ]),
                    createElement('p', { style: { marginTop: '16px', fontSize: '14px', lineHeight: '1.5' } }, [
                        'Try different keywords or browse the modules directly.'
                    ])
                ]));
                return;
            }
            
            const title = createElement('h1', { className: 'module-title' }, [
                `Search Results (${results.length})`
            ]);
            DOM.moduleContent.appendChild(title);
            
            const subtitle = createElement('p', { className: 'module-subtitle' }, [
                `Found ${results.length} matches for "`, 
                createElement('strong', {}, [AppState.searchQuery]),
                '"'
            ]);
            DOM.moduleContent.appendChild(subtitle);
            
            const groupedResults = {};
            results.forEach(result => {
                if (!groupedResults[result.module]) {
                    groupedResults[result.module] = [];
                }
                groupedResults[result.module].push(result);
            });
            
            Object.entries(groupedResults).forEach(([moduleId, moduleResults]) => {
                const moduleName = moduleResults[0].type;
                
                const groupHeader = createElement('h2', { 
                    className: 'section-header',
                    style: { marginTop: '24px' }
                }, [moduleName]);
                DOM.moduleContent.appendChild(groupHeader);
                
                moduleResults.forEach(result => {
                    const resultItem = createElement('div', { 
                        className: 'accordion',
                        onClick: () => {
                            loadModule(result.module);
                            DOM.searchInput.value = '';
                            toggleSearch();
                        }
                    }, [
                        createElement('div', { 
                            style: { 
                                padding: '16px', 
                                cursor: 'pointer',
                                display: 'flex',
                                flexDirection: 'column',
                                gap: '8px'
                            } 
                        }, [
                            createElement('div', { 
                                style: { 
                                    fontWeight: '600',
                                    fontSize: '15px',
                                    color: 'var(--text-primary)',
                                    lineHeight: '1.3'
                                }
                            }, [result.title]),
                            createElement('div', { 
                                style: { 
                                    fontSize: '14px', 
                                    color: 'var(--text-secondary)',
                                    lineHeight: '1.4'
                                }
                            }, [
                                result.content.substring(0, 120) + 
                                (result.content.length > 120 ? '...' : '')
                            ]),
                            createElement('div', { 
                                style: { 
                                    fontSize: '12px', 
                                    color: 'var(--text-tertiary)',
                                    marginTop: '4px'
                                }
                            }, ['Tap to open in ', moduleName])
                        ])
                    ]);
                    
                    DOM.moduleContent.appendChild(resultItem);
                });
            });
        }

        function saveAppState() {
            try {
                const state = {
                    theme: AppState.theme,
                    currentModule: AppState.currentModule,
                    checkedItems: Array.from(AppState.checkedItems),
                    expandedItems: Array.from(AppState.expandedItems),
                    expandedScenarios: Array.from(AppState.expandedScenarios),
                    glossaryFilter: AppState.glossaryFilter,
                    calculatorData: AppState.calculatorData
                };
                localStorage.setItem('fieldAssistantState', JSON.stringify(state));
            } catch (e) {
                console.warn('Could not save state to localStorage:', e);
            }
        }

        function loadAppState() {
            try {
                const saved = localStorage.getItem('fieldAssistantState');
                if (saved) {
                    const state = JSON.parse(saved);
                    AppState.theme = state.theme || 'light';
                    AppState.currentModule = state.currentModule || 'ts16';
                    AppState.checkedItems = new Set(state.checkedItems || []);
                    AppState.expandedItems = new Set(state.expandedItems || []);
                    AppState.expandedScenarios = new Set(state.expandedScenarios || []);
                    AppState.glossaryFilter = state.glossaryFilter || 'all';
                    AppState.calculatorData = state.calculatorData || {};
                }
            } catch (e) {
                console.warn('Could not load state from localStorage:', e);
            }
        }

        // ==============================================
        // INITIALIZATION
        // ==============================================

        function init() {
            loadAppState();
            
            document.documentElement.setAttribute('data-theme', AppState.theme);
            
            setAppHeight();
            window.addEventListener('resize', setAppHeight);
            window.addEventListener('orientationchange', setAppHeight);
            
            document.addEventListener('touchmove', preventDefaultTouchScroll, { passive: false });
            
            document.querySelector('.tab-navigation').addEventListener('click', (e) => {
                const button = e.target.closest('.tab-button');
                if (button && button.dataset.module) {
                    loadModule(button.dataset.module);
                }
            });
            
            DOM.searchToggle.addEventListener('click', toggleSearch);
            DOM.searchInput.addEventListener('input', debounce((e) => {
                performSearch(e.target.value);
            }, 300));
            
            DOM.themeToggle.addEventListener('click', toggleTheme);
            DOM.aboutToggle.addEventListener('click', showAbout);
            
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && DOM.searchOverlay.style.display !== 'none') {
                    toggleSearch();
                    loadModule(AppState.currentModule);
                }
                
                if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                    const currentIndex = Array.from(DOM.tabButtons).findIndex(btn => 
                        btn.dataset.module === AppState.currentModule
                    );
                    if (currentIndex !== -1) {
                        let newIndex;
                        if (e.key === 'ArrowLeft') {
                            newIndex = currentIndex > 0 ? currentIndex - 1 : DOM.tabButtons.length - 1;
                        } else {
                            newIndex = currentIndex < DOM.tabButtons.length - 1 ? currentIndex + 1 : 0;
                        }
                        const newModule = DOM.tabButtons[newIndex].dataset.module;
                        loadModule(newModule);
                        DOM.tabButtons[newIndex].focus();
                    }
                }
            });
            
            DOM.searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    performSearch(e.target.value);
                }
            });
            
            loadModule(AppState.currentModule);
            
            console.log('Site Engineering Assistant v1.2 initialized');
            console.log('Major Enhancements:', {
                version: 'v1.2 - Dynamic Calculators & About Section',
                new_features: [
                    'Interactive calculator module with 6 engineering calculators',
                    'About & Help module with user guide',
                    'Auto-save for calculator inputs',
                    'Enhanced search across all modules',
                    'Improved responsive design for 6 tabs'
                ],
                calculators: [
                    'Volume Calculator - Cut/Fill',
                    'Concrete Quantity Calculator',
                    'Slope Ratio to Percentage',
                    'Manhole Steps Calculator',
                    'Pavement Thickness Calculator',
                    'Area & Volume from Coordinates'
                ],
                performance: 'All original features maintained and enhanced'
            });
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
	<script src="sw-register.js" defer></script>
</body>
</html>